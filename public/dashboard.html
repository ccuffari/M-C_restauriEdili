<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuffari - AI Previsioni Costi Cantieri</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        :root {
            --primary: #003366;
            --primary-dark: #002244;
            --secondary: #ff9900;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        .container { max-width: 1400px; }
        
        /* Header */
        .header {
            background: var(--primary);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.5rem;
            color: var(--secondary);
        }
        
        .logo-text h1 {
            font-size: 1.8rem;
            margin: 0;
        }
        
        .logo-text p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin: 0;
        }
        
        /* Navigation */
        .nav-menu {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .nav-btn:hover, .nav-btn.active {
            background: rgba(255,255,255,0.1);
            border-color: var(--secondary);
        }
        
        /* Main Content */
        .main-content {
            padding: 30px 0;
        }
        
        .page-title {
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .page-subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .stat-icon i {
            font-size: 1.8rem;
            color: white;
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 1rem;
            color: #666;
            margin-bottom: 10px;
        }
        
        .stat-change {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }
        
        /* Prediction Section */
        .prediction-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .section-title {
            color: var(--primary);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .prediction-result {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            color: white;
            margin-bottom: 30px;
        }
        
        .prediction-amount {
            font-size: 3.5rem;
            font-weight: 800;
            margin: 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .prediction-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* Controls */
        .control-group {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .form-label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
            display: block;
        }
        
        .form-control, .form-select {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            width: 100%;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,51,102,0.1);
            outline: none;
        }
        
        .slider-container {
            margin: 20px 0;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .slider-value {
            font-weight: 700;
            color: var(--primary);
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e0e0e0;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-block {
            width: 100%;
            justify-content: center;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
        }
        
        .tab {
            padding: 15px 30px;
            background: none;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            position: relative;
            transition: color 0.3s;
        }
        
        .tab.active {
            color: var(--primary);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Charts */
        .chart-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            height: 400px;
        }
        
        /* Footer */
        .footer {
            background: var(--primary);
            color: white;
            padding: 40px 0;
            margin-top: 60px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .prediction-amount {
                font-size: 2.5rem;
            }
            
            .button-group {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .chart-container {
                height: 300px;
                padding: 20px;
            }
        }
        
        /* Info Box */
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid var(--primary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .info-box i {
            color: var(--primary);
            margin-right: 10px;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .loading i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        /* Alert */
        .alert {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div class="logo">
                    <i class="fas fa-brain"></i>
                    <div class="logo-text">
                        <h1>Cuffari Restauri Edili</h1>
                        <p>AI Previsioni - Sistema Intelligente</p>
                    </div>
                </div>
                
                <nav class="nav-menu">
                    <a href="construction-sites.html" class="nav-btn">
                        <i class="fas fa-hard-hat"></i>
                        <span>Cantieri</span>
                    </a>
                    <a href="estimates.html" class="nav-btn">
                        <i class="fas fa-calculator"></i>
                        <span>Preventivi</span>
                    </a>
                    <a href="suppliers.html" class="nav-btn">
                        <i class="fas fa-truck"></i>
                        <span>Fornitori</span>
                    </a>
                    <a href="#" class="nav-btn active">
                        <i class="fas fa-robot"></i>
                        <span>AI Previsioni</span>
                    </a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Info Box -->
            <div class="info-box">
                <i class="fas fa-info-circle"></i>
                <strong>Come funziona:</strong> L'AI analizza i tuoi cantieri esistenti e i materiali per prevedere i costi dei nuovi lavori. Più dati inserisci, più le previsioni diventano precise!
            </div>
            
            <!-- Stats -->
            <div class="stats-grid" id="statsContainer">
                <!-- Stats verranno popolate da JavaScript -->
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('forecast')">
                    <i class="fas fa-calculator"></i> Previsioni
                </button>
                <button class="tab" onclick="switchTab('analysis')">
                    <i class="fas fa-chart-line"></i> Analisi
                </button>
                <button class="tab" onclick="switchTab('settings')">
                    <i class="fas fa-cog"></i> Impostazioni
                </button>
            </div>
            
            <!-- Tab 1: Previsioni -->
            <div id="forecast-tab" class="tab-content active">
                <!-- Prediction Result -->
                <div class="prediction-section">
                    <h2 class="section-title">
                        <i class="fas fa-bullseye"></i> Previsione di Costo
                    </h2>
                    
                    <div class="prediction-result">
                        <div class="prediction-label">Costo previsto per questo lavoro</div>
                        <div class="prediction-amount" id="predictedTotal">€ 0</div>
                        <div class="prediction-label">
                            <i class="fas fa-shield-alt"></i>
                            Affidabilità: <span id="confidenceLevel">0%</span>
                        </div>
                    </div>
                    
                    <!-- Parameters -->
                    <div class="control-group">
                        <h3 class="section-title">
                            <i class="fas fa-sliders-h"></i> Descrizione del Lavoro
                        </h3>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Dimensione (m²)</label>
                                    <div class="slider-container">
                                        <div class="slider-label">
                                            <span>Piccolo</span>
                                            <span class="slider-value" id="surfaceValue">100 m²</span>
                                        </div>
                                        <input type="range" min="20" max="500" value="100" class="form-control" id="surfaceSlider">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Tipo di Lavoro</label>
                                    <select class="form-select" id="workType">
                                        <option value="ristrutturazione">Ristrutturazione</option>
                                        <option value="nuova_costruzione">Costruzione nuova</option>
                                        <option value="ampliamento">Ampliamento</option>
                                        <option value="restauro">Restauro</option>
                                        <option value="manutenzione">Manutenzione</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Difficoltà</label>
                                    <div class="slider-container">
                                        <div class="slider-label">
                                            <span>Semplice</span>
                                            <span class="slider-value" id="complexityValue">Media</span>
                                        </div>
                                        <input type="range" min="1" max="5" value="3" class="form-control" id="complexitySlider">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Zona</label>
                                    <select class="form-select" id="location">
                                        <option value="centro">Centro città</option>
                                        <option value="periferia">Periferia</option>
                                        <option value="campagna">Campagna</option>
                                        <option value="montagna">Montagna</option>
                                    </select>
                                </div>
                                
                                <div class="row">
                                    <div class="col-6">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="urgentCheck">
                                            <label class="form-check-label" for="urgentCheck">Urgente</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="historicCheck">
                                            <label class="form-check-label" for="historicCheck">Edificio storico</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Buttons -->
                    <div class="button-group">
                        <button class="btn btn-primary btn-block" onclick="calculatePrediction()">
                            <i class="fas fa-calculator"></i> Calcola Previsione
                        </button>
                        <button class="btn btn-success btn-block" onclick="saveEstimate()">
                            <i class="fas fa-save"></i> Salva Preventivo
                        </button>
                        <button class="btn btn-secondary btn-block" onclick="addRealCost()">
                            <i class="fas fa-plus-circle"></i> Aggiungi Costo Reale
                        </button>
                    </div>
                </div>
                
                <!-- Chart -->
                <div class="chart-container">
                    <h3 class="section-title">
                        <i class="fas fa-chart-bar"></i> Confronto con lavori simili
                    </h3>
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
            
            <!-- Tab 2: Analisi -->
            <div id="analysis-tab" class="tab-content">
                <div class="chart-container">
                    <h3 class="section-title">
                        <i class="fas fa-chart-line"></i> Andamento dei costi
                    </h3>
                    <canvas id="historyChart"></canvas>
                </div>
                
                <div class="prediction-section">
                    <h3 class="section-title">
                        <i class="fas fa-history"></i> Cronologia Lavori
                    </h3>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tipo Lavoro</th>
                                    <th>Dimensione</th>
                                    <th>Previsione</th>
                                    <th>Costo Reale</th>
                                    <th>Differenza</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable">
                                <!-- Popolato da JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Tab 3: Impostazioni -->
            <div id="settings-tab" class="tab-content">
                <div class="prediction-section">
                    <h3 class="section-title">
                        <i class="fas fa-cog"></i> Impostazioni AI
                    </h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label class="form-label">Usa dati degli ultimi</label>
                                <select class="form-select" id="dataMonths">
                                    <option value="6">6 mesi</option>
                                    <option value="12" selected>12 mesi</option>
                                    <option value="24">24 mesi</option>
                                    <option value="all">Tutti i dati</option>
                                </select>
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label">
                                    <input type="checkbox" id="autoUpdate" checked> 
                                    Aggiorna automaticamente con nuovi dati
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label class="form-label">Minimo affidabilità previsione</label>
                                <div class="slider-container">
                                    <div class="slider-label">
                                        <span>60%</span>
                                        <span class="slider-value" id="minConfidenceValue">80%</span>
                                    </div>
                                    <input type="range" min="60" max="95" value="80" class="form-control" id="minConfidence">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary btn-block" onclick="saveSettings()">
                            <i class="fas fa-save"></i> Salva Impostazioni
                        </button>
                        <button class="btn btn-secondary btn-block" onclick="resetModel()">
                            <i class="fas fa-redo"></i> Reset AI
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container text-center">
            <div class="mb-4">
                <h3>Sistema AI Previsioni</h3>
                <p>Ottimizzato per Cuffari Restauri Edili</p>
            </div>
            <p>© 2026 Cuffari Restauri Edili. Tutti i diritti riservati.</p>
        </div>
    </footer>

    <!-- Firebase Configuration -->
    <script>
        // Configurazione Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA7JiQrPYfvkRWZtdXQFw2Hj2LK0aidXYs",
            authDomain: "work-tracker-v120400.firebaseapp.com",
            projectId: "work-tracker-v120400",
            storageBucket: "work-tracker-v120400.firebasestorage.app",
            messagingSenderId: "437459935839",
            appId: "1:437459935839:web:cb0b54608314dcb25731ea",
            measurementId: "G-2LPKL9WREX"
        };
        
        // Inizializza Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>

    <!-- Main Application -->
    <script>
        // Variabili globali
        let currentUser = null;
        let mlModel = null;
        let charts = {};
        let realData = {
            constructionSites: [],
            workDays: [],
            materials: []
        };
        
        // Inizializzazione
        document.addEventListener('DOMContentLoaded', async function() {
            // Imposta utente corrente
            firebase.auth().onAuthStateChanged((user) => {
                currentUser = user;
                if (user) {
                    console.log("Utente autenticato:", user.email);
                    loadData();
                } else {
                    // Reindirizza al login se non autenticato
                    window.location.href = 'index.html';
                }
            });
            
            // Imposta slider
            setupSliders();
            
            // Inizializza grafici
            initializeCharts();
        });
        
        // Setup slider listeners
        function setupSliders() {
            // Slider superficie
            const surfaceSlider = document.getElementById('surfaceSlider');
            const surfaceValue = document.getElementById('surfaceValue');
            
            surfaceSlider.addEventListener('input', function() {
                surfaceValue.textContent = this.value + ' m²';
            });
            
            // Slider complessità
            const complexitySlider = document.getElementById('complexitySlider');
            const complexityValue = document.getElementById('complexityValue');
            const complexityLabels = ['Molto semplice', 'Semplice', 'Media', 'Difficile', 'Molto difficile'];
            
            complexitySlider.addEventListener('input', function() {
                complexityValue.textContent = complexityLabels[this.value - 1];
            });
            
            // Slider affidabilità
            const minConfidence = document.getElementById('minConfidence');
            const minConfidenceValue = document.getElementById('minConfidenceValue');
            
            minConfidence.addEventListener('input', function() {
                minConfidenceValue.textContent = this.value + '%';
            });
        }
        
        // Carica dati da Firestore
        async function loadData() {
            try {
                console.log("Caricamento dati da Firestore...");
                
                // Carica dati reali
                await Promise.all([
                    loadConstructionSites(),
                    loadWorkDays(),
                    loadMaterials(),
                    loadMLModel()
                ]);
                
                // Aggiorna statistiche
                updateStats();
                
                // Calcola previsione iniziale
                calculatePrediction();
                
                console.log("Dati caricati correttamente");
            } catch (error) {
                console.error("Errore nel caricamento dati:", error);
            }
        }
        
        async function loadConstructionSites() {
            const snapshot = await db.collection('constructionSites').get();
            realData.constructionSites = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
        }
        
        async function loadWorkDays() {
            const snapshot = await db.collection('workDays').get();
            realData.workDays = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
        }
        
        async function loadMaterials() {
            const snapshot = await db.collection('materials').get();
            realData.materials = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
        }
        
        async function loadMLModel() {
            const doc = await db.collection('mlModels').doc('currentModel').get();
            if (doc.exists) {
                mlModel = doc.data();
            } else {
                // Crea modello iniziale
                mlModel = createInitialModel();
                await saveMLModel();
            }
        }
        
        function createInitialModel() {
            return {
                // Coefficienti basati sui dati reali
                baseCostPerM2: calculateAverageCost(),
                factors: {
                    workType: {
                        ristrutturazione: 1.2,
                        nuova_costruzione: 1.0,
                        ampliamento: 1.1,
                        restauro: 1.5,
                        manutenzione: 0.8
                    },
                    complexity: [0.8, 0.9, 1.0, 1.2, 1.5],
                    location: {
                        centro: 1.3,
                        periferia: 1.0,
                        campagna: 0.9,
                        montagna: 1.1
                    },
                    urgent: 1.25,
                    historic: 1.4
                },
                accuracy: 0.75,
                lastUpdated: new Date().toISOString(),
                trainingData: realData.constructionSites.length
            };
        }
        
        function calculateAverageCost() {
            // Calcola costo medio per m² dai dati esistenti
            const sites = realData.constructionSites;
            if (sites.length === 0) return 1500; // Valore di default
            
            let totalBudget = 0;
            sites.forEach(site => {
                totalBudget += site.budget || 0;
            });
            
            // Stima superficie media (m²)
            const avgSurface = 100; // Valore stimato
            return totalBudget / (sites.length * avgSurface);
        }
        
        function updateStats() {
            const container = document.getElementById('statsContainer');
            const sites = realData.constructionSites;
            const workDays = realData.workDays;
            const materials = realData.materials;
            
            // Calcola statistiche
            const totalBudget = sites.reduce((sum, site) => sum + (site.budget || 0), 0);
            const avgProgress = sites.length > 0 ? 
                sites.reduce((sum, site) => sum + (site.progress || 0), 0) / sites.length : 0;
            const totalHours = workDays.reduce((sum, day) => sum + (day.hours || 0), 0);
            const materialValue = materials.reduce((sum, mat) => 
                sum + ((mat.unitPrice || 0) * (mat.stockQuantity || 0)), 0);
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        <i class="fas fa-hard-hat"></i>
                    </div>
                    <div class="stat-value">${sites.length}</div>
                    <div class="stat-label">Cantieri attivi</div>
                    <div class="stat-change positive">+${Math.round(avgProgress)}% completato</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #4CAF50, #2E7D32);">
                        <i class="fas fa-euro-sign"></i>
                    </div>
                    <div class="stat-value">€ ${Math.round(totalBudget).toLocaleString()}</div>
                    <div class="stat-label">Budget totale</div>
                    <div class="stat-change positive">+${sites.length} progetti</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #FF9800, #F57C00);">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-value">${Math.round(totalHours)}</div>
                    <div class="stat-label">Ore lavorate</div>
                    <div class="stat-change positive">+${workDays.length} giorni</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2);">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="stat-value">€ ${Math.round(materialValue).toLocaleString()}</div>
                    <div class="stat-label">Valore materiali</div>
                    <div class="stat-change positive">${materials.length} tipi</div>
                </div>
            `;
        }
        
        function calculatePrediction() {
            if (!mlModel) return;
            
            // Ottieni parametri
            const surface = parseInt(document.getElementById('surfaceSlider').value);
            const workType = document.getElementById('workType').value;
            const complexity = parseInt(document.getElementById('complexitySlider').value);
            const location = document.getElementById('location').value;
            const isUrgent = document.getElementById('urgentCheck').checked;
            const isHistoric = document.getElementById('historicCheck').checked;
            
            // Calcola costo base
            let costPerM2 = mlModel.baseCostPerM2;
            
            // Applica fattori
            costPerM2 *= mlModel.factors.workType[workType] || 1.0;
            costPerM2 *= mlModel.factors.complexity[complexity - 1] || 1.0;
            costPerM2 *= mlModel.factors.location[location] || 1.0;
            if (isUrgent) costPerM2 *= mlModel.factors.urgent;
            if (isHistoric) costPerM2 *= mlModel.factors.historic;
            
            // Calcola totale
            const totalCost = Math.round(costPerM2 * surface);
            
            // Calcola affidabilità basata sui dati disponibili
            const confidence = calculateConfidence(surface, workType);
            
            // Aggiorna UI
            document.getElementById('predictedTotal').textContent = `€ ${totalCost.toLocaleString()}`;
            document.getElementById('confidenceLevel').textContent = `${Math.round(confidence * 100)}%`;
            
            // Aggiorna grafico
            updateComparisonChart(totalCost, surface);
        }
        
        function calculateConfidence(surface, workType) {
            // Basa l'affidabilità sui dati disponibili
            const similarSites = realData.constructionSites.filter(site => 
                site.status === 'completed' || site.status === 'in_progress'
            );
            
            if (similarSites.length === 0) return 0.6;
            
            // Trova siti simili
            const similarType = similarSites.filter(site => 
                site.type === workType
            ).length;
            
            let confidence = 0.7;
            confidence += Math.min(similarSites.length * 0.05, 0.2); // +5% per ogni sito, max +20%
            confidence += Math.min(similarType * 0.1, 0.1); // +10% per tipo simile, max +10%
            
            return Math.min(confidence, 0.95);
        }
        
        async function saveEstimate() {
            const predictedTotal = document.getElementById('predictedTotal').textContent;
            
            // Crea nuovo preventivo
            const estimate = {
                createdAt: new Date().toISOString(),
                surface: parseInt(document.getElementById('surfaceSlider').value),
                workType: document.getElementById('workType').value,
                complexity: parseInt(document.getElementById('complexitySlider').value),
                location: document.getElementById('location').value,
                urgent: document.getElementById('urgentCheck').checked,
                historic: document.getElementById('historicCheck').checked,
                predictedCost: parseInt(predictedTotal.replace(/[^\d]/g, '')),
                confidence: parseInt(document.getElementById('confidenceLevel').textContent),
                createdBy: currentUser.uid
            };
            
            try {
                await db.collection('estimates').add(estimate);
                
                // Mostra conferma
                showAlert('success', 'Preventivo salvato con successo!');
                
                // Aggiorna modello ML
                await updateMLModel(estimate);
                
            } catch (error) {
                showAlert('warning', 'Errore nel salvataggio: ' + error.message);
            }
        }
        
        async function addRealCost() {
            const cost = prompt('Inserisci il costo REALE del lavoro (in euro):');
            if (!cost || isNaN(cost)) return;
            
            const realCost = parseInt(cost);
            const predictedTotal = parseInt(document.getElementById('predictedTotal').textContent.replace(/[^\d]/g, ''));
            const difference = ((realCost - predictedTotal) / predictedTotal * 100).toFixed(1);
            
            // Salva nel database
            const realData = {
                date: new Date().toISOString(),
                surface: parseInt(document.getElementById('surfaceSlider').value),
                workType: document.getElementById('workType').value,
                predictedCost: predictedTotal,
                realCost: realCost,
                difference: parseFloat(difference),
                parameters: {
                    complexity: parseInt(document.getElementById('complexitySlider').value),
                    location: document.getElementById('location').value,
                    urgent: document.getElementById('urgentCheck').checked,
                    historic: document.getElementById('historicCheck').checked
                }
            };
            
            try {
                await db.collection('mlRealData').add(realData);
                
                showAlert('success', `Costo reale registrato! Differenza: ${difference}%`);
                
                // Aggiorna modello
                await retrainModel();
                
            } catch (error) {
                showAlert('warning', 'Errore: ' + error.message);
            }
        }
        
        async function updateMLModel(newEstimate) {
            // Aggiorna coefficienti del modello
            const sites = realData.constructionSites;
            if (sites.length === 0) return;
            
            // Ricalcola costo medio
            mlModel.baseCostPerM2 = calculateAverageCost();
            mlModel.trainingData = sites.length;
            mlModel.lastUpdated = new Date().toISOString();
            
            await saveMLModel();
        }
        
        async function retrainModel() {
            try {
                // Carica dati reali
                const snapshot = await db.collection('mlRealData').get();
                const realDataPoints = snapshot.docs.map(doc => doc.data());
                
                if (realDataPoints.length < 3) {
                    showAlert('info', 'Servono almeno 3 costi reali per migliorare il modello');
                    return;
                }
                
                // Migliora il modello basandosi sui dati reali
                let totalError = 0;
                realDataPoints.forEach(point => {
                    const error = Math.abs(point.difference || 0);
                    totalError += error;
                });
                
                const avgError = totalError / realDataPoints.length;
                mlModel.accuracy = Math.max(0.6, Math.min(0.95, 1 - (avgError / 100)));
                
                // Aggiorna coefficienti
                mlModel.baseCostPerM2 = calculateAverageCost();
                mlModel.lastUpdated = new Date().toISOString();
                mlModel.trainingData = realDataPoints.length;
                
                await saveMLModel();
                
                showAlert('success', `Modello migliorato! Accuratezza: ${Math.round(mlModel.accuracy * 100)}%`);
                
            } catch (error) {
                console.error("Errore nel riaddestramento:", error);
            }
        }
        
        async function saveMLModel() {
            await db.collection('mlModels').doc('currentModel').set(mlModel);
        }
        
        async function saveSettings() {
            const settings = {
                dataMonths: document.getElementById('dataMonths').value,
                autoUpdate: document.getElementById('autoUpdate').checked,
                minConfidence: parseInt(document.getElementById('minConfidence').value) / 100
            };
            
            await db.collection('mlSettings').doc('current').set(settings);
            showAlert('success', 'Impostazioni salvate!');
        }
        
        async function resetModel() {
            if (confirm("Vuoi resettare l'AI ai valori iniziali? I dati storici verranno mantenuti.")) {
                mlModel = createInitialModel();
                await saveMLModel();
                calculatePrediction();
                showAlert('success', 'AI resettata con successo!');
            }
        }
        
        function switchTab(tabName) {
            // Nascondi tutte le tab
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostra tab selezionata
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Attiva tab button
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.onclick && tab.onclick.toString().includes(tabName)) {
                    tab.classList.add('active');
                }
            });
        }
        
        function initializeCharts() {
            // Grafico di confronto
            const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
            charts.comparison = new Chart(comparisonCtx, {
                type: 'bar',
                data: {
                    labels: ['Questa previsione', 'Media lavori simili', 'Costo più basso', 'Costo più alto'],
                    datasets: [{
                        label: 'Costo (€)',
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(255, 159, 64, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Costo (€)'
                            }
                        }
                    }
                }
            });
            
            // Grafico storico
            const historyCtx = document.getElementById('historyChart').getContext('2d');
            charts.history = new Chart(historyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Costi previsti',
                            data: [],
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'Costi reali',
                            data: [],
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Costo (€)'
                            }
                        }
                    }
                }
            });
        }
        
        function updateComparisonChart(predictedCost, surface) {
            if (!charts.comparison) return;
            
            // Calcola dati di confronto
            const sites = realData.constructionSites;
            const similarSites = sites.filter(site => site.budget && site.budget > 0);
            
            let avgSimilar = predictedCost;
            let minSimilar = predictedCost * 0.7;
            let maxSimilar = predictedCost * 1.3;
            
            if (similarSites.length > 0) {
                const budgets = similarSites.map(site => site.budget);
                avgSimilar = budgets.reduce((a, b) => a + b, 0) / budgets.length;
                minSimilar = Math.min(...budgets);
                maxSimilar = Math.max(...budgets);
            }
            
            // Aggiorna grafico
            charts.comparison.data.datasets[0].data = [
                predictedCost,
                avgSimilar,
                minSimilar,
                maxSimilar
            ];
            charts.comparison.update();
        }
        
        function showAlert(type, message) {
            // Crea alert
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                ${message}
            `;
            
            // Aggiungi all'inizio del main content
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Rimuovi dopo 5 secondi
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Calcola prima previsione
        setTimeout(() => {
            calculatePrediction();
        }, 1000);
    </script>
</body>
</html>
