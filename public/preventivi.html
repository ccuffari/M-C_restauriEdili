<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marocco&Cuffari - Gestione Preventivi</title>
    <link rel="stylesheet" href="styles/style.css">    
    <link rel="stylesheet" href="styles/preventivi.css">
    <link rel="stylesheet" href="styles/footer.css">  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body>
    <div class="dashboard-page" id="dashboardPage">
        <!-- Navbar -->
        <nav class="navbar">
            <div class="navbar-container">
                <div class="navbar-brand">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="logo">
                        <i class="fas fa-hard-hat"></i>
                        <span>Marocco<span class="logo-highlight">&</span>Cuffari</span>
                    </div>
                </div>
                
                <div class="navbar-user">
                    <div class="user-info" id="userDropdownToggle">
                        <div class="user-avatar" id="userAvatar">
                            <!-- Initials will be set by JavaScript -->
                        </div>
                        <div class="user-details">
                            <div class="user-name" id="userName">Caricamento...</div>
                            <div class="user-role" id="userRole">Caricamento...</div>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    
                    <div class="user-dropdown" id="userDropdown">
                        <a href="index.html">
                            <i class="fas fa-home"></i>
                            Dashboard Principale
                        </a>
                        <a href="cantieri.html">
                            <i class="fas fa-hard-hat"></i>
                            Gestione Cantieri
                        </a>
                        <a href="lavoro.html">
                            <i class="fas fa-calendar-alt"></i>
                            Giornate Lavorative
                        </a>
                        <a href="preventivi.html">
                            <i class="fas fa-file-contract"></i>
                            Preventivi
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            Esci
                        </a>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Main Container -->
        <div class="main-container">
            <!-- La sidebar verrà caricata dinamicamente -->
            
            <div class="page-content" id="mainContent">
                <!-- Alert Container -->
                <div id="alertContainer"></div>
                
                <!-- Page Header -->
                <div class="page-header">
                    <h1><i class="fas fa-file-contract"></i> Gestione Preventivi</h1>
                    <div class="header-actions">
                        <button class="btn btn-success" id="addPreventivoBtn">
                            <i class="fas fa-plus"></i>
                            Nuovo Preventivo
                        </button>
                    </div>
                </div>
                
                <!-- Stats Overview -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="color: var(--accent);">
                            <i class="fas fa-file-contract"></i>
                        </div>
                        <div class="stat-number" id="totalPreventivi">0</div>
                        <div class="stat-label">Preventivi Totali</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="color: var(--success);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-number" id="preventiviApprovati">0</div>
                        <div class="stat-label">Approvati</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="color: var(--warning);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-number" id="preventiviInAttesa">0</div>
                        <div class="stat-label">In Attesa</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="color: var(--info);">
                            <i class="fas fa-euro-sign"></i>
                        </div>
                        <div class="stat-number" id="totalePreventivi">€0</div>
                        <div class="stat-label">Valore Totale</div>
                    </div>
                </div>
                
                <!-- Tabella preventivi -->
                <div class="content-card">
                    <div class="card-header">
                        <h3><i class="fas fa-list"></i> Elenco Preventivi</h3>
                        <div style="width: 300px;">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="preventiviSearch" placeholder="Cerca preventivi...">
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="data-table-wrapper">
                            <table class="data-table" id="preventiviTable">
                                <thead>
                                    <tr>
                                        <th>Numero</th>
                                        <th>Data</th>
                                        <th>Cliente</th>
                                        <th>Importo</th>
                                        <th>Validità</th>
                                        <th>Stato</th>
                                        <th>File</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="preventiviTableBody">
                                    <!-- Preventivi caricate dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                        <div id="preventiviLoading" class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Caricamento preventivi...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modale per aggiungere/modificare preventivo -->
    <div class="modal" id="preventivoModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="preventivoModalTitle"><i class="fas fa-plus"></i> Nuovo Preventivo</h3>
                <button class="modal-close" id="closePreventivoModal">&times;</button>
            </div>
            <form id="preventivoForm">
                <div class="modal-body">
                    <div id="preventivoAlert" class="alert hidden"></div>
                    <input type="hidden" id="preventivoId">
                    
                    <div class="row">
                        <div class="form-group">
                            <label for="preventivoNumero">Numero Preventivo *</label>
                            <input type="text" id="preventivoNumero" placeholder="PREV/2024/001" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="preventivoData">Data *</label>
                            <input type="date" id="preventivoData" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="form-group">
                            <label for="preventivoCliente">Cliente *</label>
                            <input type="text" id="preventivoCliente" placeholder="Nome cliente" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="preventivoImporto">Importo (€) *</label>
                            <input type="number" id="preventivoImporto" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="form-group">
                            <label for="preventivoValidita">Validità (giorni) *</label>
                            <input type="number" id="preventivoValidita" min="1" value="30" required>
                            <small class="small-text">Numero di giorni di validità del preventivo</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="preventivoStato">Stato *</label>
                            <select id="preventivoStato" required>
                                <option value="in_attesa">In Attesa</option>
                                <option value="approvato">Approvato</option>
                                <option value="rifiutato">Rifiutato</option>
                                <option value="scaduto">Scaduto</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="form-group">
                            <label for="preventivoCantiere">Cantiere Associato</label>
                            <select id="preventivoCantiere">
                                <option value="">Nessun cantiere</option>
                                <!-- Popolato dinamicamente -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="preventivoReferente">Referente Cliente</label>
                            <input type="text" id="preventivoReferente" placeholder="Nome referente">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="preventivoDescrizione">Descrizione Lavori *</label>
                        <textarea id="preventivoDescrizione" rows="4" placeholder="Descrizione dettagliata dei lavori..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="preventivoNote">Note Aggiuntive</label>
                        <textarea id="preventivoNote" rows="3" placeholder="Note interne..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>File Preventivo</label>
                        <div class="row">
                            <div class="form-group" style="flex: 1;">
                                <div class="file-upload-container" id="wordFileContainer">
                                    <div class="file-upload-icon">
                                        <i class="fas fa-file-word"></i>
                                    </div>
                                    <div class="file-upload-text">
                                        <h4>File Word (.docx) *</h4>
                                        <p>Template compilato</p>
                                        <input type="file" id="wordFileInput" accept=".doc,.docx" style="display: none;" required>
                                        <button type="button" class="btn btn-primary" id="selectWordFileBtn">
                                            <i class="fas fa-folder-open"></i>
                                            Seleziona Word
                                        </button>
                                    </div>
                                </div>
                                <div id="wordFilePreview" class="file-preview hidden">
                                    <!-- Anteprima Word -->
                                </div>
                            </div>
                            
                            <div class="form-group" style="flex: 1;">
                                <div class="file-upload-container" id="pdfFileContainer">
                                    <div class="file-upload-icon">
                                        <i class="fas fa-file-pdf"></i>
                                    </div>
                                    <div class="file-upload-text">
                                        <h4>File PDF (Opzionale)</h4>
                                        <p>Versione per il cliente</p>
                                        <input type="file" id="pdfFileInput" accept=".pdf" style="display: none;">
                                        <button type="button" class="btn btn-secondary" id="selectPdfFileBtn">
                                            <i class="fas fa-folder-open"></i>
                                            Seleziona PDF
                                        </button>
                                    </div>
                                </div>
                                <div id="pdfFilePreview" class="file-preview hidden">
                                    <!-- Anteprima PDF -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-2">
                            <i class="fas fa-sync-alt"></i>
                            <strong>Nota:</strong> Carica il file Word del preventivo (obbligatorio). Puoi anche caricare una versione PDF già convertita.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelPreventivo">Annulla</button>
                    <button type="submit" class="btn btn-primary" id="submitPreventivo">
                        <i class="fas fa-save"></i>
                        Salva Preventivo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="scripts/loadSidebar.js"></script>
    
    <script>
        // Firebase Configuration (caricata dal file JSON)
        let firebaseConfig = null;
        let auth = null;
        let db = null;
        let storage = null;
        
        // Carica la configurazione Firebase dal file JSON
        async function loadFirebaseConfig() {
            try {
                const response = await fetch('firebase_config.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                firebaseConfig = await response.json();
                
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                storage = firebase.storage();
                
                console.log('Firebase configurato correttamente');
                return true;
            } catch (error) {
                console.error('Errore nel caricamento della configurazione Firebase:', error);
                showAlert('error', 'Errore nel caricamento della configurazione. Controlla il file firebase_config.json');
                return false;
            }
        }
        
        // Variabili globali
        let currentUser = null;
        let currentUserData = null;
        let allPreventivi = [];
        let allCantieri = [];
        
        // DOM elements
        const addPreventivoBtn = document.getElementById('addPreventivoBtn');
        const preventiviTableBody = document.getElementById('preventiviTableBody');
        const preventivoModal = document.getElementById('preventivoModal');
        const preventivoForm = document.getElementById('preventivoForm');
        const closePreventivoModal = document.getElementById('closePreventivoModal');
        const cancelPreventivo = document.getElementById('cancelPreventivo');
        
        // Stats elements
        const totalPreventivi = document.getElementById('totalPreventivi');
        const preventiviApprovati = document.getElementById('preventiviApprovati');
        const preventiviInAttesa = document.getElementById('preventiviInAttesa');
        const totalePreventivi = document.getElementById('totalePreventivi');
        
        // File upload elements
        const wordFileInput = document.getElementById('wordFileInput');
        const pdfFileInput = document.getElementById('pdfFileInput');
        const selectWordFileBtn = document.getElementById('selectWordFileBtn');
        const selectPdfFileBtn = document.getElementById('selectPdfFileBtn');
        const wordFileContainer = document.getElementById('wordFileContainer');
        const pdfFileContainer = document.getElementById('pdfFileContainer');
        const wordFilePreview = document.getElementById('wordFilePreview');
        const pdfFilePreview = document.getElementById('pdfFilePreview');
        
        // User dropdown elements
        const userDropdownToggle = document.getElementById('userDropdownToggle');
        const userDropdown = document.getElementById('userDropdown');
        const logoutBtn = document.getElementById('logoutBtn');
        const menuToggle = document.getElementById('menuToggle');
        
        // Initialize app
        async function initApp() {
            // Carica la configurazione Firebase
            const configLoaded = await loadFirebaseConfig();
            if (!configLoaded) {
                return;
            }
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserData(user.uid);
                    showDashboard();
                } else {
                    window.location.href = 'index.html';
                }
            });
            
            // Event listeners
            addPreventivoBtn.addEventListener('click', () => {
                document.getElementById('preventivoModalTitle').innerHTML = '<i class="fas fa-plus"></i> Nuovo Preventivo';
                preventivoForm.reset();
                clearFilePreviews();
                document.getElementById('preventivoData').valueAsDate = new Date();
                preventivoModal.classList.add('show');
                loadCantieriDropdown();
            });
            
            closePreventivoModal.addEventListener('click', () => {
                preventivoModal.classList.remove('show');
            });
            
            cancelPreventivo.addEventListener('click', () => {
                preventivoModal.classList.remove('show');
            });
            
            preventivoForm.addEventListener('submit', savePreventivo);
            
            // File upload
            selectWordFileBtn.addEventListener('click', () => wordFileInput.click());
            selectPdfFileBtn.addEventListener('click', () => pdfFileInput.click());
            
            setupFileDragDrop(wordFileContainer, wordFileInput, wordFilePreview, 'word');
            setupFileDragDrop(pdfFileContainer, pdfFileInput, pdfFilePreview, 'pdf');
            
            // Search
            document.getElementById('preventiviSearch')?.addEventListener('input', filterPreventivi);
            
            // User dropdown
            userDropdownToggle.addEventListener('click', () => {
                userDropdown.classList.toggle('show');
            });
            
            logoutBtn.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error('Error signing out:', error);
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!userDropdownToggle.contains(e.target) && !userDropdown.contains(e.target)) {
                    userDropdown.classList.remove('show');
                }
            });
        }
        
        async function loadUserData(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    currentUserData = userDoc.data();
                    updateUserDisplay();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        function updateUserDisplay() {
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            const userAvatar = document.getElementById('userAvatar');
            
            if (currentUserData) {
                userName.textContent = currentUserData.name || currentUser.email.split('@')[0];
                userRole.textContent = currentUserData.role || 'Utente';
                
                // Set avatar initials
                const nameParts = (currentUserData.name || '').split(' ');
                if (nameParts.length >= 2) {
                    userAvatar.innerHTML = (nameParts[0][0] + nameParts[1][0]).toUpperCase();
                } else if (currentUserData.name) {
                    userAvatar.innerHTML = currentUserData.name[0].toUpperCase();
                } else {
                    userAvatar.innerHTML = currentUser.email[0].toUpperCase();
                }
            } else {
                userName.textContent = currentUser.email.split('@')[0];
                userRole.textContent = 'Utente';
                userAvatar.innerHTML = currentUser.email[0].toUpperCase();
            }
        }
        
        function showDashboard() {
            updateUserDisplay();
            loadCantieri();
            loadPreventivi();
        }
        
        // Setup drag & drop per file
        function setupFileDragDrop(container, fileInput, previewElement, fileType) {
            const acceptTypes = fileType === 'word' 
                ? ['.doc', '.docx', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document']
                : ['.pdf', 'application/pdf'];
            
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                container.classList.add('dragover');
            });
            
            container.addEventListener('dragleave', () => {
                container.classList.remove('dragover');
            });
            
            container.addEventListener('drop', (e) => {
                e.preventDefault();
                container.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    const isValidType = acceptTypes.some(type => 
                        file.type.includes(type.replace('.', '')) || file.name.toLowerCase().endsWith(type)
                    );
                    
                    if (isValidType) {
                        showFilePreview(file, previewElement, fileType);
                    } else {
                        showAlert('error', `Si prega di selezionare un file ${fileType === 'word' ? 'Word (.doc/.docx)' : 'PDF'}`);
                    }
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    showFilePreview(e.target.files[0], previewElement, fileType);
                }
            });
        }
        
        function showFilePreview(file, previewElement, fileType) {
            previewElement.classList.remove('hidden');
            previewElement.innerHTML = `
                <i class="fas fa-file-${fileType === 'word' ? 'word' : 'pdf'}"></i>
                <div style="flex: 1;">
                    <strong>${file.name}</strong><br>
                    <small>${(file.size / 1024).toFixed(2)} KB</small>
                </div>
                <button type="button" class="btn btn-icon" onclick="clearSingleFilePreview('${fileType}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Memorizza il file nella variabile appropriata
            if (fileType === 'word') {
                window.wordFile = file;
            } else {
                window.pdfFile = file;
            }
        }
        
        function clearFilePreviews() {
            wordFilePreview.classList.add('hidden');
            pdfFilePreview.classList.add('hidden');
            wordFileInput.value = '';
            pdfFileInput.value = '';
            window.wordFile = null;
            window.pdfFile = null;
        }
        
        function clearSingleFilePreview(fileType) {
            if (fileType === 'word') {
                wordFilePreview.classList.add('hidden');
                wordFileInput.value = '';
                window.wordFile = null;
            } else {
                pdfFilePreview.classList.add('hidden');
                pdfFileInput.value = '';
                window.pdfFile = null;
            }
        }
        
        // Carica cantieri
        async function loadCantieri() {
            try {
                const snapshot = await db.collection('cantieri').get();
                allCantieri = [];
                snapshot.forEach(doc => {
                    allCantieri.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Error loading cantieri:', error);
            }
        }
        
        function loadCantieriDropdown() {
            const select = document.getElementById('preventivoCantiere');
            select.innerHTML = '<option value="">Nessun cantiere</option>';
            allCantieri.forEach(cantiere => {
                const option = document.createElement('option');
                option.value = cantiere.id;
                option.textContent = cantiere.nome || cantiere.indirizzo || `Cantiere ${cantiere.id.substring(0, 8)}`;
                select.appendChild(option);
            });
        }
        
        // Carica preventivi
        async function loadPreventivi() {
            preventiviTableBody.innerHTML = '';
            document.getElementById('preventiviLoading').classList.remove('hidden');
            
            try {
                const snapshot = await db.collection('preventivi').orderBy('data', 'desc').get();
                allPreventivi = [];
                
                let totalApprovati = 0;
                let totalInAttesa = 0;
                let totaleImporto = 0;
                
                snapshot.forEach(doc => {
                    const preventivo = doc.data();
                    const preventivoId = doc.id;
                    allPreventivi.push({ id: preventivoId, ...preventivo });
                    
                    // Calcola statistiche
                    if (preventivo.stato === 'approvato') totalApprovati++;
                    if (preventivo.stato === 'in_attesa') totalInAttesa++;
                    totaleImporto += parseFloat(preventivo.importo) || 0;
                    
                    // Crea riga tabella
                    const row = document.createElement('tr');
                    
                    let statoBadge = '';
                    switch(preventivo.stato) {
                        case 'approvato':
                            statoBadge = '<span class="status-approved">Approvato</span>';
                            break;
                        case 'rifiutato':
                            statoBadge = '<span class="status-rejected">Rifiutato</span>';
                            break;
                        case 'scaduto':
                            statoBadge = '<span class="status-rejected">Scaduto</span>';
                            break;
                        default:
                            statoBadge = '<span class="status-pending">In Attesa</span>';
                    }
                    
                    // Calcola data scadenza
                    const dataPreventivo = new Date(preventivo.data);
                    const scadenza = new Date(dataPreventivo);
                    scadenza.setDate(scadenza.getDate() + (preventivo.validita || 30));
                    
                    row.innerHTML = `
                        <td><strong>${preventivo.numero || 'N/D'}</strong></td>
                        <td>${formatDate(preventivo.data)}</td>
                        <td>${preventivo.cliente || ''}</td>
                        <td class="amount">€${parseFloat(preventivo.importo || 0).toFixed(2)}</td>
                        <td>${formatDate(scadenza)}<br><small>${preventivo.validita || 30} giorni</small></td>
                        <td>${statoBadge}</td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                ${preventivo.wordUrl ? 
                                    `<span class="file-type-badge word">
                                        <i class="fas fa-file-word"></i>
                                        Word
                                        <button class="btn btn-icon" style="padding: 0; font-size: 0.8rem;" 
                                                onclick="downloadFile('${preventivo.wordUrl}', '${preventivo.wordFileName || 'preventivo.docx'}')">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </span>` : ''}
                                ${preventivo.pdfUrl ? 
                                    `<span class="file-type-badge pdf">
                                        <i class="fas fa-file-pdf"></i>
                                        PDF
                                        <button class="btn btn-icon" style="padding: 0; font-size: 0.8rem;" 
                                                onclick="downloadFile('${preventivo.pdfUrl}', '${preventivo.pdfFileName || 'preventivo.pdf'}')">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </span>` : ''}
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-icon edit-preventivo-btn" data-id="${preventivoId}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-icon delete-preventivo-btn" data-id="${preventivoId}" data-numero="${preventivo.numero}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    preventiviTableBody.appendChild(row);
                });
                
                // Aggiorna statistiche
                totalPreventivi.textContent = allPreventivi.length;
                preventiviApprovati.textContent = totalApprovati;
                preventiviInAttesa.textContent = totalInAttesa;
                totalePreventivi.textContent = `€${totaleImporto.toFixed(2)}`;
                
                // Aggiungi event listeners
                document.querySelectorAll('.edit-preventivo-btn').forEach(btn => {
                    btn.addEventListener('click', () => editPreventivo(btn.getAttribute('data-id')));
                });
                
                document.querySelectorAll('.delete-preventivo-btn').forEach(btn => {
                    btn.addEventListener('click', () => deletePreventivo(
                        btn.getAttribute('data-id'),
                        btn.getAttribute('data-numero')
                    ));
                });
                
            } catch (error) {
                console.error('Error loading preventivi:', error);
                showAlert('error', 'Errore nel caricamento dei preventivi');
            } finally {
                document.getElementById('preventiviLoading').classList.add('hidden');
            }
        }
        
        // Salva preventivo
        async function savePreventivo(e) {
            e.preventDefault();
            
            if (!window.wordFile) {
                showAlert('error', 'Si prega di selezionare il file Word del preventivo');
                return;
            }
            
            const submitBtn = document.getElementById('submitPreventivo');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvataggio...';
            submitBtn.disabled = true;
            
            try {
                // Upload file Word
                const storageRef = storage.ref();
                const wordFileRef = storageRef.child(`preventivi/word/${Date.now()}_${window.wordFile.name}`);
                await wordFileRef.put(window.wordFile);
                const wordUrl = await wordFileRef.getDownloadURL();
                
                // Upload file PDF se presente
                let pdfUrl = '';
                let pdfFileName = '';
                if (window.pdfFile) {
                    const pdfFileRef = storageRef.child(`preventivi/pdf/${Date.now()}_${window.pdfFile.name}`);
                    await pdfFileRef.put(window.pdfFile);
                    pdfUrl = await pdfFileRef.getDownloadURL();
                    pdfFileName = window.pdfFile.name;
                }
                
                // Prepara dati preventivo
                const preventivoData = {
                    numero: document.getElementById('preventivoNumero').value,
                    data: document.getElementById('preventivoData').value,
                    cliente: document.getElementById('preventivoCliente').value,
                    importo: parseFloat(document.getElementById('preventivoImporto').value),
                    validita: parseInt(document.getElementById('preventivoValidita').value),
                    stato: document.getElementById('preventivoStato').value,
                    cantiereId: document.getElementById('preventivoCantiere').value || null,
                    referente: document.getElementById('preventivoReferente').value || '',
                    descrizione: document.getElementById('preventivoDescrizione').value,
                    note: document.getElementById('preventivoNote').value || '',
                    wordUrl: wordUrl,
                    wordFileName: window.wordFile.name,
                    pdfUrl: pdfUrl,
                    pdfFileName: pdfFileName,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.uid
                };
                
                // Calcola data scadenza
                const dataPreventivo = new Date(preventivoData.data);
                const scadenza = new Date(dataPreventivo);
                scadenza.setDate(scadenza.getDate() + preventivoData.validita);
                preventivoData.scadenza = scadenza.toISOString().split('T')[0];
                
                const preventivoId = document.getElementById('preventivoId').value;
                if (preventivoId) {
                    // Aggiornamento
                    await db.collection('preventivi').doc(preventivoId).update(preventivoData);
                } else {
                    // Nuovo preventivo
                    preventivoData.createdAt = new Date().toISOString();
                    preventivoData.createdBy = currentUser.uid;
                    await db.collection('preventivi').add(preventivoData);
                }
                
                // Chiudi modal e ricarica
                preventivoModal.classList.remove('show');
                clearFilePreviews();
                loadPreventivi();
                showAlert('success', preventivoId ? 'Preventivo aggiornato!' : 'Preventivo creato!');
                
            } catch (error) {
                console.error('Error saving preventivo:', error);
                showAlert('error', 'Errore durante il salvataggio: ' + error.message);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
        
        // Download file
        function downloadFile(url, fileName) {
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Edit preventivo
        function editPreventivo(id) {
            const preventivo = allPreventivi.find(p => p.id === id);
            if (!preventivo) return;
            
            // Popola form
            document.getElementById('preventivoId').value = id;
            document.getElementById('preventivoNumero').value = preventivo.numero;
            document.getElementById('preventivoData').value = preventivo.data;
            document.getElementById('preventivoCliente').value = preventivo.cliente;
            document.getElementById('preventivoImporto').value = preventivo.importo;
            document.getElementById('preventivoValidita').value = preventivo.validita || 30;
            document.getElementById('preventivoStato').value = preventivo.stato;
            document.getElementById('preventivoCantiere').value = preventivo.cantiereId || '';
            document.getElementById('preventivoReferente').value = preventivo.referente || '';
            document.getElementById('preventivoDescrizione').value = preventivo.descrizione;
            document.getElementById('preventivoNote').value = preventivo.note || '';
            
            // Mostra preview file esistenti
            if (preventivo.wordUrl) {
                wordFilePreview.classList.remove('hidden');
                wordFilePreview.innerHTML = `
                    <i class="fas fa-file-word"></i>
                    <div style="flex: 1;">
                        <strong>${preventivo.wordFileName || 'preventivo.docx'}</strong><br>
                        <small>File già caricato</small>
                    </div>
                    <button type="button" class="btn btn-icon" onclick="clearSingleFilePreview('word')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            }
            
            if (preventivo.pdfUrl) {
                pdfFilePreview.classList.remove('hidden');
                pdfFilePreview.innerHTML = `
                    <i class="fas fa-file-pdf"></i>
                    <div style="flex: 1;">
                        <strong>${preventivo.pdfFileName || 'preventivo.pdf'}</strong><br>
                        <small>File già caricato</small>
                    </div>
                    <button type="button" class="btn btn-icon" onclick="clearSingleFilePreview('pdf')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            }
            
            document.getElementById('preventivoModalTitle').innerHTML = '<i class="fas fa-edit"></i> Modifica Preventivo';
            loadCantieriDropdown();
            preventivoModal.classList.add('show');
        }
        
        async function deletePreventivo(id, numero) {
            if (!confirm(`Sei sicuro di voler eliminare il preventivo ${numero}?`)) return;
            
            try {
                await db.collection('preventivi').doc(id).delete();
                loadPreventivi();
                showAlert('success', 'Preventivo eliminato!');
            } catch (error) {
                console.error('Error deleting preventivo:', error);
                showAlert('error', 'Errore durante l\'eliminazione');
            }
        }
        
        function filterPreventivi() {
            const term = document.getElementById('preventiviSearch').value.toLowerCase();
            const rows = preventiviTableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString('it-IT');
        }
        
        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            const container = document.getElementById('alertContainer');
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode === container) {
                    alert.remove();
                }
            }, 5000);
        }
        
        // Inizializza app
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

    <!-- Includi il footer -->
    <script>
        // Carica il footer
        fetch('footer.html')
            .then(response => response.text())
            .then(data => {
                document.body.insertAdjacentHTML('beforeend', data);
            })
            .catch(error => {
                console.error('Errore nel caricamento del footer:', error);
                // Fallback: crea un footer minimale se il caricamento fallisce
                const fallbackFooter = document.createElement('footer');
                fallbackFooter.className = 'dashboard-footer';
                fallbackFooter.innerHTML = `
                    <div class="footer-container">
                        <p>&copy; ${new Date().getFullYear()} Marocco&Cuffari Ristauri Edili</p>
                        <p class="developer-credit">Sviluppato da Cristian Felice Cuffari</p>
                    </div>
                `;
                document.body.appendChild(fallbackFooter);
            });
    </script>
</body>
</html>