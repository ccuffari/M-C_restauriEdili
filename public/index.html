<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marocco&Cuffari - Gestione Sistema</title>
    <link rel="stylesheet" href="styles/style.css">
    <link rel="stylesheet" href="styles/styles/login.css">
    <link rel="stylesheet" href="styles/dashboard.css">
    <link rel="stylesheet" href="styles/setting.css">
    <link rel="stylesheet" href="styles/footer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

</head>
<body>
    <!-- Login Page -->
    <div class="login-page" id="loginPage">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <div class="logo">
                        <i class="fas fa-hard-hat"></i>
                        <span>Marocco<span class="logo-highlight">&</span>Cuffari</span>
                    </div>
                    <h1>Ristauri Edili</h1>
                    <p>Piattaforma di Gestione Sistema</p>
                </div>
                
                <form class="login-form" id="loginForm">
                    <div id="loginAlert" class="alert hidden"></div>
                    
                    <div class="form-group">
                        <label for="email">
                            <i class="fas fa-envelope"></i>
                            Email
                        </label>
                        <input type="email" id="email" placeholder="Inserisci la tua email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">
                            <i class="fas fa-lock"></i>
                            Password
                        </label>
                        <input type="password" id="password" placeholder="Inserisci la tua password" required>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block" id="loginBtn">
                            <i class="fas fa-sign-in-alt"></i>
                            Accedi
                        </button>
                    </div>
                </form>
                
                <div class="form-footer">
                    <p class="small-text">Piattaforma sviluppata per <strong>Marocco&Cuffari Ristauri Edili</strong><br>by Cristian Felice Cuffari</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Page -->
    <div class="dashboard-page" id="dashboardPage">
        <!-- Navbar -->
        <nav class="navbar">
            <div class="navbar-container">
                <div class="navbar-brand">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="logo">
                        <i class="fas fa-hard-hat"></i>
                        <span>Marocco<span class="logo-highlight">&</span>Cuffari</span>
                    </div>
                </div>
                
                <div class="navbar-user">
                    <div class="user-info" id="userDropdownToggle">
                        <div class="user-avatar" id="userAvatar">
                            <!-- Initials will be set by JavaScript -->
                        </div>
                        <div class="user-details">
                            <div class="user-name" id="userName">Caricamento...</div>
                            <div class="user-role" id="userRole">Caricamento...</div>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    
                    <div class="user-dropdown" id="userDropdown">
                        <a href="#" data-section="profile">
                            <i class="fas fa-user"></i>
                            Il mio profilo
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            Esci
                        </a>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Main Container -->
        <div class="main-container">
            <!-- La sidebar verrà caricata dinamicamente qui -->
            <!-- Content Area -->
            <div class="page-content" id="mainContent">
                <!-- Alert Container -->
                <div id="alertContainer"></div>
                
                <!-- Welcome Section -->
                <div class="welcome-card" id="welcomeSection">
                    <h1>Benvenuto nel Sistema di Gestione</h1>
                    <p>Accedi alle funzioni di amministrazione dal menu laterale. Gestisci utenti, ruoli, impostazioni e molto altro.</p>
                    <div class="mt-3">
                        <a href="#profile" class="btn btn-primary">
                            <i class="fas fa-user"></i>
                            Vai al Profilo
                        </a>
                        <a href="#users" class="btn btn-secondary ml-2">
                            <i class="fas fa-users"></i>
                            Gestione Utenti
                        </a>
                    </div>
                </div>
                
                <!-- Profile Section -->
                <div class="page-section" id="profile">
                    <h2><i class="fas fa-user"></i> Il Mio Profilo</h2>
                    <div class="form-group">
                        <label for="profileName">Nome Completo</label>
                        <input type="text" id="profileName" placeholder="Nome e cognome">
                    </div>
                    
                    <div class="form-group">
                        <label for="profileEmail">Email</label>
                        <input type="email" id="profileEmail" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="profileRole">Ruolo</label>
                        <input type="text" id="profileRole" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="profilePhone">Telefono</label>
                        <input type="tel" id="profilePhone" placeholder="+39 123 456 7890">
                    </div>
                    
                    <div class="form-group">
                        <label for="profileAddress">Indirizzo</label>
                        <textarea id="profileAddress" rows="3" placeholder="Indirizzo completo"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="profileCreated">Data di registrazione</label>
                        <input type="text" id="profileCreated" readonly>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-primary" id="saveProfileBtn">
                            <i class="fas fa-save"></i>
                            Salva Modifiche
                        </button>
                    </div>
                    
                    <div class="content-card mt-3">
                        <div class="card-header">
                            <h3><i class="fas fa-lock"></i> Cambia Password</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="currentPassword">Password Attuale</label>
                                <input type="password" id="currentPassword">
                            </div>
                            
                            <div class="form-group">
                                <label for="newPassword">Nuova Password</label>
                                <input type="password" id="newPassword">
                            </div>
                            
                            <div class="form-group">
                                <label for="confirmPassword">Conferma Nuova Password</label>
                                <input type="password" id="confirmPassword">
                            </div>
                            
                            <button class="btn btn-primary" id="changePasswordBtn">
                                <i class="fas fa-key"></i>
                                Cambia Password
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Section -->
                <div class="page-section" id="settings">
                    <h2><i class="fas fa-cog"></i> Impostazioni Sistema</h2>
                    
                    <div class="settings-section">
                        <h3><i class="fas fa-bell"></i> Notifiche</h3>
                        
                        <div class="settings-row">
                            <div class="settings-label">
                                <h4>Notifiche Email</h4>
                                <p>Ricevi notifiche via email per attività importanti</p>
                            </div>
                            <div class="settings-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="emailNotifications">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="settings-row">
                            <div class="settings-label">
                                <h4>Notifiche Sistema</h4>
                                <p>Mostra notifiche nel browser per azioni importanti</p>
                            </div>
                            <div class="settings-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="systemNotifications">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3><i class="fas fa-shield-alt"></i> Sicurezza</h3>
                        
                        <div class="form-group">
                            <label for="sessionTimeout">Timeout Sessione (minuti)</label>
                            <input type="number" id="sessionTimeout" min="5" max="480" value="30" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="passwordExpiry">Scadenza Password (giorni)</label>
                            <input type="number" id="passwordExpiry" min="1" max="365" value="90" class="form-control">
                        </div>
                        
                        <div class="settings-row">
                            <div class="settings-label">
                                <h4>Richiedi verifica email</h4>
                                <p>Gli utenti devono verificare l'email per accedere</p>
                            </div>
                            <div class="settings-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="requireEmailVerification">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-primary" id="saveSettingsBtn">
                            <i class="fas fa-save"></i>
                            Salva Impostazioni
                        </button>
                    </div>
                </div>
                
                <!-- Users Section -->
                <div class="page-section" id="users">
                    <h2><i class="fas fa-users-cog"></i> Gestione Utenti</h2>
                    
                    <div class="header-actions">
                        <button class="btn btn-primary" id="addUserBtn">
                            <i class="fas fa-user-plus"></i>
                            Aggiungi Utente
                        </button>
                    </div>
                    
                    <div class="content-card mt-3">
                        <div class="card-header">
                            <h3><i class="fas fa-users"></i> Utenti Registrati</h3>
                            <div style="width: 250px;">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="userSearch" placeholder="Cerca utenti...">
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="data-table-wrapper">
                                <table class="data-table" id="usersTable">
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Email</th>
                                            <th>Ruolo</th>
                                            <th>Stato</th>
                                            <th>Ultimo Accesso</th>
                                            <th>Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <!-- Users will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="usersLoading" class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Caricamento utenti...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Roles Section -->
                <div class="page-section" id="roles">
                    <h2><i class="fas fa-user-tag"></i> Gestione Ruoli</h2>
                    
                    <div class="content-card">
                        <div class="card-header">
                            <h3><i class="fas fa-user-tag"></i> Ruoli Disponibili</h3>
                        </div>
                        <div class="card-body">
                            <div class="roles-grid">
                                <div class="role-card">
                                    <h4><span class="badge badge-cto">CTO</span> Chief Technology Officer</h4>
                                    <p>Accesso completo a tutte le funzioni del sistema. Può gestire tutti gli utenti, ruoli e impostazioni.</p>
                                    <div class="permissions">
                                        <span class="permission-badge"><i class="fas fa-check"></i> Tutti i permessi</span>
                                    </div>
                                </div>
                                
                                <div class="role-card">
                                    <h4><span class="badge badge-ceo">CEO</span> Chief Executive Officer</h4>
                                    <p>Accesso completo alle funzioni aziendali. Può gestire utenti e impostazioni ma non modificare i ruoli Chief.</p>
                                    <div class="permissions">
                                        <span class="permission-badge"><i class="fas fa-check"></i> Gestione Utenti</span>
                                        <span class="permission-badge"><i class="fas fa-check"></i> Impostazioni Sistema</span>
                                    </div>
                                </div>
                                
                                <div class="role-card">
                                    <h4><span class="badge badge-cfo">CFO</span> Chief Financial Officer</h4>
                                    <p>Accesso alle funzioni finanziarie e gestione utenti base. Può gestire impostazioni sistema.</p>
                                    <div class="permissions">
                                        <span class="permission-badge"><i class="fas fa-check"></i> Gestione Utenti Base</span>
                                        <span class="permission-badge"><i class="fas fa-check"></i> Impostazioni Finanziarie</span>
                                    </div>
                                </div>
                                
                                <div class="role-card">
                                    <h4><span class="badge badge-primary">Amministrativo</span></h4>
                                    <p>Accesso alle funzioni amministrative. Non può gestire utenti o ruoli.</p>
                                    <div class="permissions">
                                        <span class="permission-badge"><i class="fas fa-check"></i> Gestione Documenti</span>
                                        <span class="permission-badge"><i class="fas fa-check"></i> Report</span>
                                        <span class="permission-badge"><i class="fas fa-times"></i> Gestione Utenti</span>
                                    </div>
                                </div>
                                
                                <div class="role-card">
                                    <h4><span class="badge badge-warning">Capocantiere</span></h4>
                                    <p>Accesso alle funzioni di cantiere. Gestione team e materiali.</p>
                                    <div class="permissions">
                                        <span class="permission-badge"><i class="fas fa-check"></i> Gestione Cantieri</span>
                                        <span class="permission-badge"><i class="fas fa-check"></i> Gestione Team</span>
                                        <span class="permission-badge"><i class="fas fa-times"></i> Gestione Utenti</span>
                                    </div>
                                </div>
                                
                                <div class="role-card">
                                    <h4><span class="badge badge-success">Operaio</span></h4>
                                    <p>Accesso base per visualizzare compiti e registrare ore lavorate.</p>
                                    <div class="permissions">
                                        <span class="permission-badge"><i class="fas fa-check"></i> Visualizzazione Compiti</span>
                                        <span class="permission-badge"><i class="fas fa-check"></i> Registrazione Ore</span>
                                        <span class="permission-badge"><i class="fas fa-times"></i> Gestione</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="content-card mt-3">
                        <div class="card-header">
                            <h3><i class="fas fa-shield-alt"></i> Permessi Ruoli</h3>
                        </div>
                        <div class="card-body">
                            <div class="permissions-table">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Permesso</th>
                                            <th>CTO</th>
                                            <th>CEO</th>
                                            <th>CFO</th>
                                            <th>Amministrativo</th>
                                            <th>Capocantiere</th>
                                            <th>Operaio</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Gestione Utenti</td>
                                            <td><i class="fas fa-check text-success"></i></td>
                                            <td><i class="fas fa-check text-success"></i></td>
                                            <td><i class="fas fa-check text-success"></i></td>
                                            <td><i class="fas fa-times text-danger"></i></td>
                                            <td><i class="fas fa-times text-danger"></i></td>
                                            <td><i class="fas fa-times text-danger"></i></td>
                                        </tr>
                                        <tr>
                                            <td>Impostazioni Sistema</td>
                                            <td><i class="fas fa-check text-success"></i></td>
                                            <td><i class="fas fa-check text-success"></i></td>
                                            <td><i class="fas fa-check text-success"></i></td>
                                            <td><i class="fas fa-times text-danger"></i></td>
                                            <td><i class="fas fa-times text-danger"></i></td>
                                            <td><i class="fas fa-times text-danger"></i></td>
                                        </tr>
                                        <tr>
                                            <td>Gestione Ruoli</td>
                                            <td><i class="fas fa-check text-success"></i></td>
                                            <td><i class="fas fa-times text-danger"></i></td>
                                            <td><i class="fas fa-times text-danger"></i></td>
                                            <td><i class="fas fa-times text-danger"></i></td>
                                            <td><i class="fas fa-times text-danger"></i></td>
                                            <td><i class="fas fa-times text-danger"></i></td>
                                        </tr>
                                        <tr>
                                            <td>Gestione Documenti</td>
                                            <td><i class="fas fa-check text-success"></i></td>
                                            <td><i class="fas fa-check text-success"></i></td>
                                            <td><i class="fas fa-check text-success"></i></td>
                                            <td><i class="fas fa-check text-success"></i></td>
                                            <td><i class="fas fa-check text-success"></i></td>
                                            <td><i class="fas fa-times text-danger"></i></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add User Modal -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Aggiungi Nuovo Utente</h3>
                <button class="modal-close" id="closeAddUserModal">&times;</button>
            </div>
            <form id="addUserForm">
                <div class="modal-body">
                    <div id="addUserAlert" class="alert hidden"></div>
                    
                    <div class="form-group">
                        <label for="newUserName">Nome Completo *</label>
                        <input type="text" id="newUserName" placeholder="Nome e cognome" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="newUserEmail">Email *</label>
                        <input type="email" id="newUserEmail" placeholder="email@marocco-cuffari.it" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="newUserRole">Ruolo *</label>
                        <select id="newUserRole" class="form-control" required>
                            <option value="">Seleziona un ruolo</option>
                            <option value="operaio">Operaio</option>
                            <option value="capocantiere">Capocantiere</option>
                            <option value="amministrativo">Amministrativo</option>
                            <option value="cfo">CFO - Chief Financial Officer</option>
                            <option value="ceo">CEO - Chief Executive Officer</option>
                            <option value="cto">CTO - Chief Technology Officer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="newUserPhone">Telefono</label>
                        <input type="tel" id="newUserPhone" placeholder="+39 123 456 7890">
                    </div>
                    
                    <div class="form-group">
                        <label for="newUserPassword">Password *</label>
                        <input type="password" id="newUserPassword" placeholder="Minimo 6 caratteri" required minlength="6">
                    </div>
                    
                    <div class="form-group">
                        <label for="newUserConfirmPassword">Conferma Password *</label>
                        <input type="password" id="newUserConfirmPassword" placeholder="Conferma la password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelAddUser">Annulla</button>
                    <button type="submit" class="btn btn-primary" id="submitAddUser">
                        <i class="fas fa-user-plus"></i>
                        Crea Utente
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div class="modal" id="editUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-edit"></i> Modifica Utente</h3>
                <button class="modal-close" id="closeEditUserModal">&times;</button>
            </div>
            <form id="editUserForm">
                <div class="modal-body">
                    <div id="editUserAlert" class="alert hidden"></div>
                    <input type="hidden" id="editUserId">
                    
                    <div class="form-group">
                        <label for="editUserName">Nome Completo *</label>
                        <input type="text" id="editUserName" placeholder="Nome e cognome" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editUserEmail">Email</label>
                        <input type="email" id="editUserEmail" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="editUserRole">Ruolo *</label>
                        <select id="editUserRole" class="form-control" required>
                            <option value="">Seleziona un ruolo</option>
                            <option value="operaio">Operaio</option>
                            <option value="capocantiere">Capocantiere</option>
                            <option value="amministrativo">Amministrativo</option>
                            <option value="cfo">CFO - Chief Financial Officer</option>
                            <option value="ceo">CEO - Chief Executive Officer</option>
                            <option value="cto">CTO - Chief Technology Officer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editUserPhone">Telefono</label>
                        <input type="tel" id="editUserPhone" placeholder="+39 123 456 7890">
                    </div>
                    
                    <div class="form-group">
                        <label for="editUserAddress">Indirizzo</label>
                        <textarea id="editUserAddress" rows="2" placeholder="Indirizzo completo"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editUserStatus">Stato Account</label>
                        <select id="editUserStatus" class="form-control">
                            <option value="active">Attivo</option>
                            <option value="inactive">Disabilitato</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelEditUser">Annulla</button>
                    <button type="submit" class="btn btn-primary" id="submitEditUser">
                        <i class="fas fa-save"></i>
                        Salva Modifiche
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Includi lo script della sidebar -->
    <script src="scripts/loadSidebar.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA7JiQrPYfvkRWZtdXQFw2Hj2LK0aidXYs",
            authDomain: "work-tracker-v120400.firebaseapp.com",
            projectId: "work-tracker-v120400",
            storageBucket: "work-tracker-v120400.firebasestorage.app",
            messagingSenderId: "437459935839",
            appId: "1:437459935839:web:cb0b54608314dcb25731ea",
            measurementId: "G-2LPKL9WREX"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Current user data
        let currentUser = null;
        let currentUserData = null;
        let allUsers = [];
        
        // DOM elements
        const loginPage = document.getElementById('loginPage');
        const dashboardPage = document.getElementById('dashboardPage');
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const loginAlert = document.getElementById('loginAlert');
        const logoutBtn = document.getElementById('logoutBtn');
        const userDropdownToggle = document.getElementById('userDropdownToggle');
        const userDropdown = document.getElementById('userDropdown');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        const userAvatar = document.getElementById('userAvatar');
        const alertContainer = document.getElementById('alertContainer');
        
        // Profile elements
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const profileRole = document.getElementById('profileRole');
        const profilePhone = document.getElementById('profilePhone');
        const profileAddress = document.getElementById('profileAddress');
        const profileCreated = document.getElementById('profileCreated');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const currentPassword = document.getElementById('currentPassword');
        const newPassword = document.getElementById('newPassword');
        const confirmPassword = document.getElementById('confirmPassword');
        
        // Settings elements
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        
        // Users elements
        const addUserBtn = document.getElementById('addUserBtn');
        const usersTableBody = document.getElementById('usersTableBody');
        const usersLoading = document.getElementById('usersLoading');
        const userSearch = document.getElementById('userSearch');
        
        // Modals
        const addUserModal = document.getElementById('addUserModal');
        const closeAddUserModal = document.getElementById('closeAddUserModal');
        const cancelAddUser = document.getElementById('cancelAddUser');
        const addUserForm = document.getElementById('addUserForm');
        const addUserAlert = document.getElementById('addUserAlert');
        
        const editUserModal = document.getElementById('editUserModal');
        const closeEditUserModal = document.getElementById('closeEditUserModal');
        const cancelEditUser = document.getElementById('cancelEditUser');
        const editUserForm = document.getElementById('editUserForm');
        const editUserAlert = document.getElementById('editUserAlert');
        
        // Helper functions for roles
        function isChief(role) {
            return ['cto', 'ceo', 'cfo'].includes(role);
        }
        
        function getRoleDisplayName(role) {
            const roles = {
                'cto': 'CTO - Chief Technology Officer',
                'ceo': 'CEO - Chief Executive Officer',
                'cfo': 'CFO - Chief Financial Officer',
                'capocantiere': 'Capocantiere',
                'operaio': 'Operaio',
                'amministrativo': 'Amministrativo'
            };
            return roles[role] || role;
        }
        
        function getRoleBadgeClass(role) {
            const badgeClasses = {
                'cto': 'badge-cto',
                'ceo': 'badge-ceo',
                'cfo': 'badge-cfo',
                'capocantiere': 'badge-warning',
                'operaio': 'badge-success',
                'amministrativo': 'badge-primary'
            };
            return badgeClasses[role] || 'badge-primary';
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        // Initialize the application
        function initApp() {
            // Check if user is already logged in
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    await loadUserData(user.uid);
                    showDashboard();
                } else {
                    // No user is signed in
                    showLogin();
                }
            });
            
            // Set up event listeners
            loginForm.addEventListener('submit', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            userDropdownToggle.addEventListener('click', toggleUserDropdown);
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!userDropdownToggle.contains(e.target) && !userDropdown.contains(e.target)) {
                    userDropdown.classList.remove('show');
                }
            });
            
            // Profile events
            saveProfileBtn.addEventListener('click', saveProfile);
            changePasswordBtn.addEventListener('click', changePassword);
            
            // Settings events
            saveSettingsBtn.addEventListener('click', saveSettings);
            
            // Users events
            addUserBtn.addEventListener('click', () => {
                addUserModal.classList.add('show');
                addUserAlert.classList.add('hidden');
                addUserForm.reset();
            });
            
            closeAddUserModal.addEventListener('click', () => {
                addUserModal.classList.remove('show');
            });
            
            cancelAddUser.addEventListener('click', () => {
                addUserModal.classList.remove('show');
            });
            
            addUserForm.addEventListener('submit', addNewUser);
            
            closeEditUserModal.addEventListener('click', () => {
                editUserModal.classList.remove('show');
            });
            
            cancelEditUser.addEventListener('click', () => {
                editUserModal.classList.remove('show');
            });
            
            editUserForm.addEventListener('submit', updateUser);
            
            // Search users
            userSearch?.addEventListener('input', filterUsers);
            
            // User dropdown navigation
            document.querySelector('.user-dropdown a[data-section]')?.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.target.closest('a').getAttribute('data-section');
                window.location.hash = section;
            });
            
            // Carica gli utenti all'avvio se siamo nella sezione users
            if (window.location.hash === '#users') {
                loadUsers();
            }
        }
        
        // Show login page
        function showLogin() {
            loginPage.style.display = 'flex';
            dashboardPage.style.display = 'none';
            loginForm.reset();
            loginAlert.classList.add('hidden');
        }
        
        // Show dashboard
        function showDashboard() {
            loginPage.style.display = 'none';
            dashboardPage.style.display = 'flex';
            updateUserDisplay();
        }
        
        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Accesso in corso...';
            loginBtn.disabled = true;
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                await loadUserData(currentUser.uid);
                showDashboard();
                showAlert('success', 'Accesso effettuato con successo!');
            } catch (error) {
                console.error('Login error:', error);
                showLoginAlert('Email o password non validi. Riprova.');
            } finally {
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Accedi';
                loginBtn.disabled = false;
            }
        }
        
        // Show login alert
        function showLoginAlert(message) {
            loginAlert.textContent = message;
            loginAlert.className = 'alert alert-error';
            loginAlert.classList.remove('hidden');
        }
        
        // Load user data from Firestore
        async function loadUserData(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    currentUserData = userDoc.data();
                } else {
                    // Create user data if it doesn't exist
                    currentUserData = {
                        name: currentUser.displayName || currentUser.email.split('@')[0],
                        email: currentUser.email,
                        role: 'operaio', // Default role
                        phone: '',
                        address: '',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        lastLogin: new Date().toISOString()
                    };
                    await db.collection('users').doc(uid).set(currentUserData);
                }
                
                // Update last login time
                await db.collection('users').doc(uid).update({
                    lastLogin: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error loading user data:', error);
                showAlert('error', 'Errore nel caricamento dei dati utente');
            }
        }
        
        // Handle logout
        function handleLogout(e) {
            e.preventDefault();
            auth.signOut().then(() => {
                currentUser = null;
                currentUserData = null;
                showLogin();
                showAlert('success', 'Logout effettuato con successo');
            }).catch((error) => {
                console.error('Logout error:', error);
                showAlert('error', 'Errore durante il logout');
            });
        }
        
        // Toggle user dropdown
        function toggleUserDropdown() {
            userDropdown.classList.toggle('show');
        }
        
        // Update user display information
        function updateUserDisplay() {
            if (!currentUserData) return;
            
            // Update navbar
            userName.textContent = currentUserData.name;
            userRole.textContent = getRoleDisplayName(currentUserData.role);
            userAvatar.textContent = getInitials(currentUserData.name);
            
            // Update profile page
            profileName.value = currentUserData.name;
            profileEmail.value = currentUserData.email;
            profileRole.value = getRoleDisplayName(currentUserData.role);
            profilePhone.value = currentUserData.phone || '';
            profileAddress.value = currentUserData.address || '';
            
            if (currentUserData.createdAt) {
                const date = new Date(currentUserData.createdAt);
                profileCreated.value = date.toLocaleDateString('it-IT', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            }
        }
        
        // Save profile changes
        async function saveProfile() {
            if (!currentUser || !currentUserData) return;
            
            const updatedData = {
                name: profileName.value.trim(),
                phone: profilePhone.value.trim(),
                address: profileAddress.value.trim(),
                updatedAt: new Date().toISOString()
            };
            
            // Validate name
            if (!updatedData.name) {
                showAlert('error', 'Il nome è obbligatorio');
                return;
            }
            
            saveProfileBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvataggio...';
            saveProfileBtn.disabled = true;
            
            try {
                // Update in Firestore
                await db.collection('users').doc(currentUser.uid).update(updatedData);
                
                // Update local data
                Object.assign(currentUserData, updatedData);
                
                // Update display
                updateUserDisplay();
                
                showAlert('success', 'Profilo aggiornato con successo!');
            } catch (error) {
                console.error('Error updating profile:', error);
                showAlert('error', 'Errore durante il salvataggio del profilo');
            } finally {
                saveProfileBtn.innerHTML = '<i class="fas fa-save"></i> Salva Modifiche';
                saveProfileBtn.disabled = false;
            }
        }
        
        // Change password
        async function changePassword() {
            const currentPwd = currentPassword.value;
            const newPwd = newPassword.value;
            const confirmPwd = confirmPassword.value;
            
            // Validate
            if (!currentPwd || !newPwd || !confirmPwd) {
                showAlert('error', 'Tutti i campi sono obbligatori');
                return;
            }
            
            if (newPwd.length < 6) {
                showAlert('error', 'La nuova password deve avere almeno 6 caratteri');
                return;
            }
            
            if (newPwd !== confirmPwd) {
                showAlert('error', 'Le password non corrispondono');
                return;
            }
            
            changePasswordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aggiornamento...';
            changePasswordBtn.disabled = true;
            
            try {
                // Reauthenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email, 
                    currentPwd
                );
                await currentUser.reauthenticateWithCredential(credential);
                
                // Update password
                await currentUser.updatePassword(newPwd);
                
                // Clear form
                currentPassword.value = '';
                newPassword.value = '';
                confirmPassword.value = '';
                
                showAlert('success', 'Password aggiornata con successo!');
            } catch (error) {
                console.error('Error changing password:', error);
                if (error.code === 'auth/wrong-password') {
                    showAlert('error', 'La password corrente non è corretta');
                } else {
                    showAlert('error', 'Errore durante la modifica della password');
                }
            } finally {
                changePasswordBtn.innerHTML = '<i class="fas fa-key"></i> Cambia Password';
                changePasswordBtn.disabled = false;
            }
        }
        
        // Load settings
        async function loadSettings() {
            try {
                const settingsDoc = await db.collection('settings').doc('system').get();
                if (settingsDoc.exists) {
                    const settings = settingsDoc.data();
                    
                    // Update form fields
                    document.getElementById('emailNotifications').checked = settings.emailNotifications || false;
                    document.getElementById('systemNotifications').checked = settings.systemNotifications || false;
                    document.getElementById('sessionTimeout').value = settings.sessionTimeout || 30;
                    document.getElementById('passwordExpiry').value = settings.passwordExpiry || 90;
                    document.getElementById('requireEmailVerification').checked = settings.requireEmailVerification || false;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        // Save settings
        async function saveSettings() {
            const settings = {
                emailNotifications: document.getElementById('emailNotifications').checked,
                systemNotifications: document.getElementById('systemNotifications').checked,
                sessionTimeout: parseInt(document.getElementById('sessionTimeout').value),
                passwordExpiry: parseInt(document.getElementById('passwordExpiry').value),
                requireEmailVerification: document.getElementById('requireEmailVerification').checked,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser.uid
            };
            
            saveSettingsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvataggio...';
            saveSettingsBtn.disabled = true;
            
            try {
                await db.collection('settings').doc('system').set(settings, { merge: true });
                showAlert('success', 'Impostazioni salvate con successo!');
            } catch (error) {
                console.error('Error saving settings:', error);
                showAlert('error', 'Errore durante il salvataggio delle impostazioni');
            } finally {
                saveSettingsBtn.innerHTML = '<i class="fas fa-save"></i> Salva Impostazioni';
                saveSettingsBtn.disabled = false;
            }
        }
        
        // Load users
        async function loadUsers() {
            usersTableBody.innerHTML = '';
            usersLoading.classList.remove('hidden');
            
            try {
                const usersSnapshot = await db.collection('users').orderBy('name').get();
                allUsers = [];
                usersTableBody.innerHTML = '';
                
                usersSnapshot.forEach((doc) => {
                    const user = doc.data();
                    const userId = doc.id;
                    
                    allUsers.push({ id: userId, ...user });
                    
                    const row = document.createElement('tr');
                    
                    // Format last login date
                    let lastLogin = 'Mai';
                    if (user.lastLogin) {
                        const date = new Date(user.lastLogin);
                        lastLogin = date.toLocaleDateString('it-IT');
                    }
                    
                    // Determine status badge
                    let statusBadge = '<span class="badge badge-success">Attivo</span>';
                    if (user.status === 'inactive') {
                        statusBadge = '<span class="badge badge-danger">Disabilitato</span>';
                    }
                    
                    row.innerHTML = `
                        <td>${user.name || 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td><span class="badge ${getRoleBadgeClass(user.role)}">${getRoleDisplayName(user.role)}</span></td>
                        <td>${statusBadge}</td>
                        <td>${lastLogin}</td>
                        <td>
                            <button class="btn btn-icon edit-user-btn" data-id="${userId}">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${userId !== currentUser.uid ? `
                            <button class="btn btn-icon delete-user-btn" data-id="${userId}" data-name="${user.name}">
                                <i class="fas fa-trash"></i>
                            </button>
                            ` : ''}
                        </td>
                    `;
                    
                    usersTableBody.appendChild(row);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('.edit-user-btn').forEach(btn => {
                    btn.addEventListener('click', () => editUser(btn.getAttribute('data-id')));
                });
                
                document.querySelectorAll('.delete-user-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteUser(
                        btn.getAttribute('data-id'), 
                        btn.getAttribute('data-name')
                    ));
                });
                
            } catch (error) {
                console.error('Error loading users:', error);
                showAlert('error', 'Errore nel caricamento degli utenti');
            } finally {
                usersLoading.classList.add('hidden');
            }
        }
        
        // Filter users
        function filterUsers() {
            const searchTerm = userSearch.value.toLowerCase();
            const rows = usersTableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // Add new user
        async function addNewUser(e) {
            e.preventDefault();
            
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const role = document.getElementById('newUserRole').value;
            const phone = document.getElementById('newUserPhone').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const confirmPassword = document.getElementById('newUserConfirmPassword').value;
            
            // Validate
            if (!name || !email || !role || !password || !confirmPassword) {
                showModalAlert(addUserAlert, 'error', 'Tutti i campi obbligatori devono essere compilati');
                return;
            }
            
            if (password.length < 6) {
                showModalAlert(addUserAlert, 'error', 'La password deve avere almeno 6 caratteri');
                return;
            }
            
            if (password !== confirmPassword) {
                showModalAlert(addUserAlert, 'error', 'Le password non corrispondono');
                return;
            }
            
            const submitBtn = document.getElementById('submitAddUser');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creazione...';
            submitBtn.disabled = true;
            
            try {
                // Create user in Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const newUser = userCredential.user;
                
                // Create user data in Firestore
                const userData = {
                    name: name,
                    email: email,
                    role: role,
                    phone: phone,
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    createdBy: currentUser.uid
                };
                
                await db.collection('users').doc(newUser.uid).set(userData);
                
                // Send email verification
                await newUser.sendEmailVerification();
                
                // Close modal and reset form
                addUserModal.classList.remove('show');
                addUserForm.reset();
                
                // Reload users list
                loadUsers();
                
                showAlert('success', `Utente ${name} creato con successo!`);
            } catch (error) {
                console.error('Error creating user:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showModalAlert(addUserAlert, 'error', 'Questo indirizzo email è già in uso');
                } else if (error.code === 'auth/invalid-email') {
                    showModalAlert(addUserAlert, 'error', 'Indirizzo email non valido');
                } else {
                    showModalAlert(addUserAlert, 'error', 'Errore durante la creazione dell\'utente');
                }
            } finally {
                submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> Crea Utente';
                submitBtn.disabled = false;
            }
        }
        
        // Edit user
        async function editUser(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    showAlert('error', 'Utente non trovato');
                    return;
                }
                
                const user = userDoc.data();
                
                // Fill form
                document.getElementById('editUserId').value = userId;
                document.getElementById('editUserName').value = user.name || '';
                document.getElementById('editUserEmail').value = user.email || '';
                document.getElementById('editUserRole').value = user.role || 'operaio';
                document.getElementById('editUserPhone').value = user.phone || '';
                document.getElementById('editUserAddress').value = user.address || '';
                document.getElementById('editUserStatus').value = user.status || 'active';
                
                // Clear alert and show modal
                editUserAlert.classList.add('hidden');
                editUserModal.classList.add('show');
            } catch (error) {
                console.error('Error loading user for edit:', error);
                showAlert('error', 'Errore nel caricamento dei dati utente');
            }
        }
        
        // Update user
        async function updateUser(e) {
            e.preventDefault();
            
            const userId = document.getElementById('editUserId').value;
            const name = document.getElementById('editUserName').value.trim();
            const role = document.getElementById('editUserRole').value;
            const phone = document.getElementById('editUserPhone').value.trim();
            const address = document.getElementById('editUserAddress').value.trim();
            const status = document.getElementById('editUserStatus').value;
            
            // Validate
            if (!name || !role) {
                showModalAlert(editUserAlert, 'error', 'Nome e ruolo sono obbligatori');
                return;
            }
            
            const submitBtn = document.getElementById('submitEditUser');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvataggio...';
            submitBtn.disabled = true;
            
            try {
                const updatedData = {
                    name: name,
                    role: role,
                    phone: phone,
                    address: address,
                    status: status,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.uid
                };
                
                await db.collection('users').doc(userId).update(updatedData);
                
                // Close modal
                editUserModal.classList.remove('show');
                
                // Reload users list
                loadUsers();
                
                showAlert('success', 'Utente aggiornato con successo!');
            } catch (error) {
                console.error('Error updating user:', error);
                showModalAlert(editUserAlert, 'error', 'Errore durante l\'aggiornamento dell\'utente');
            } finally {
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Salva Modifiche';
                submitBtn.disabled = false;
            }
        }
        
        // Delete user
        async function deleteUser(userId, userName) {
            if (!confirm(`Sei sicuro di voler eliminare l'utente "${userName}"?`)) {
                return;
            }
            
            try {
                // Delete from Firestore
                await db.collection('users').doc(userId).delete();
                
                // Reload users list
                loadUsers();
                
                showAlert('success', `Utente "${userName}" eliminato con successo!`);
            } catch (error) {
                console.error('Error deleting user:', error);
                showAlert('error', 'Errore durante l\'eliminazione dell\'utente');
            }
        }
        
        // Show alert
        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'info' ? 'info-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // Show modal alert
        function showModalAlert(container, type, message) {
            container.textContent = message;
            container.className = `alert alert-${type}`;
            container.classList.remove('hidden');
        }
        
        // Get initials from name
        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }
        
        // Carica settings se siamo nella sezione settings
        if (window.location.hash === '#settings') {
            loadSettings();
        }
        
        // Inizializza l'applicazione
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

        <!-- Includi il footer -->
    <script>
        // Carica il footer
        fetch('footer.html')
            .then(response => response.text())
            .then(data => {
                document.body.insertAdjacentHTML('beforeend', data);
            })
            .catch(error => {
                console.error('Errore nel caricamento del footer:', error);
                // Fallback: crea un footer minimale se il caricamento fallisce
                const fallbackFooter = document.createElement('footer');
                fallbackFooter.className = 'dashboard-footer';
                fallbackFooter.innerHTML = `
                    <div class="footer-container">
                        <p>&copy; ${new Date().getFullYear()} Marocco&Cuffari Ristauri Edili</p>
                        <p class="developer-credit">Sviluppato da Cristian Felice Cuffari</p>
                    </div>
                `;
                document.body.appendChild(fallbackFooter);
            });
    </script>
</body>

</html>