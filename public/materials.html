const functions = require('firebase-functions');
const nodemailer = require('nodemailer');
const admin = require('firebase-admin');

admin.initializeApp();

const transporter = nodemailer.createTransport({
  service: 'gmail',
  auth: {
    user: functions.config().gmail.email,
    pass: functions.config().gmail.password
  }
});

exports.sendAlertEmail = functions.firestore
  .document('notifications/{notificationId}')
  .onCreate(async (snap, context) => {
    const notification = snap.data();
    
    if (notification.status !== 'pending') return null;
    
    // Recupera email utente
    const userDoc = await admin.firestore()
      .collection('users')
      .doc(notification.userId)
      .get();
    
    const userEmail = userDoc.data()?.email;
    if (!userEmail) return null;
    
    // Prepara email
    const mailOptions = {
      from: `"Cuffari AI System" <${functions.config().gmail.email}>`,
      to: userEmail,
      subject: notification.content.subject,
      html: notification.content.body
    };
    
    try {
      await transporter.sendMail(mailOptions);
      
      // Aggiorna stato notifica
      await snap.ref.update({
        status: 'sent',
        sentAt: admin.firestore.FieldValue.serverTimestamp()
      });
      
      console.log(`Email sent to ${userEmail}`);
      
    } catch (error) {
      console.error('Error sending email:', error);
      await snap.ref.update({
        status: 'failed',
        error: error.message
      });
    }
    
    return null;
  });
