<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marocco&Cuffari - Giornate Lavorative</title>
    <link rel="stylesheet" href="styles/style.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
</head>
<body>
    <!-- Dashboard Page -->
    <div class="dashboard-page" id="dashboardPage">
        <!-- Navbar -->
        <nav class="navbar">
            <div class="navbar-container">
                <div class="navbar-brand">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="logo">
                        <i class="fas fa-hard-hat"></i>
                        <span>Marocco<span class="logo-highlight">&</span>Cuffari</span>
                    </div>
                </div>
                
                <div class="navbar-user">
                    <div class="user-info" id="userDropdownToggle">
                        <div class="user-avatar" id="userAvatar">
                            <!-- Initials will be set by JavaScript -->
                        </div>
                        <div class="user-details">
                            <div class="user-name" id="userName">Caricamento...</div>
                            <div class="user-role" id="userRole">Caricamento...</div>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    
                    <div class="user-dropdown" id="userDropdown">
                        <a href="index.html">
                            <i class="fas fa-home"></i>
                            Dashboard Principale
                        </a>
                        <a href="cantieri.html">
                            <i class="fas fa-hard-hat"></i>
                            Gestione Cantieri
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            Esci
                        </a>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Main Container -->
        <div class="main-container">
            <!-- La sidebar verrÃ  caricata dinamicamente qui -->
            
            <!-- Content Area -->
            <div class="page-content" id="mainContent">
                <!-- Alert Container -->
                <div id="alertContainer"></div>
                
                <!-- Page Header -->
                <div class="page-header">
                    <h1><i class="fas fa-calendar-alt"></i> Giornate Lavorative</h1>
                    <div class="header-actions">
                        <button class="btn btn-success" id="addGiornataBtn">
                            <i class="fas fa-plus"></i>
                            Nuova Giornata
                        </button>
                    </div>
                </div>
                
                <!-- Filtri -->
                <div class="content-card">
                    <div class="card-header">
                        <h3><i class="fas fa-filter"></i> Filtri</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="form-group">
                                <label for="filterMese">Mese</label>
                                <select id="filterMese" class="form-control">
                                    <option value="current">Mese Corrente</option>
                                    <option value="01">Gennaio</option>
                                    <option value="02">Febbraio</option>
                                    <option value="03">Marzo</option>
                                    <option value="04">Aprile</option>
                                    <option value="05">Maggio</option>
                                    <option value="06">Giugno</option>
                                    <option value="07">Luglio</option>
                                    <option value="08">Agosto</option>
                                    <option value="09">Settembre</option>
                                    <option value="10">Ottobre</option>
                                    <option value="11">Novembre</option>
                                    <option value="12">Dicembre</option>
                                    <option value="all">Tutti i mesi</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="filterAnno">Anno</label>
                                <select id="filterAnno" class="form-control">
                                    <!-- Popolato dinamicamente -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="filterUtente">Utente</label>
                                <select id="filterUtente" class="form-control">
                                    <option value="all">Tutti gli utenti</option>
                                    <!-- Popolato dinamicamente -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="filterCantiere">Cantiere</label>
                                <select id="filterCantiere" class="form-control">
                                    <option value="all">Tutti i cantieri</option>
                                    <option value="none">Nessun cantiere</option>
                                    <!-- Popolato dinamicamente -->
                                </select>
                            </div>
                            
                            <div class="form-group" style="align-self: flex-end;">
                                <button class="btn btn-primary" id="applyFiltersBtn">
                                    <i class="fas fa-search"></i>
                                    Applica Filtri
                                </button>
                                <button class="btn btn-secondary" id="resetFiltersBtn">
                                    <i class="fas fa-redo"></i>
                                    Reset
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Stats Overview -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="color: var(--accent);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-number" id="totalOre">0</div>
                        <div class="stat-label">Ore Lavoro</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="color: var(--warning);">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="stat-number" id="totalStraordinario">0</div>
                        <div class="stat-label">Straordinario</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="color: var(--info);">
                            <i class="fas fa-umbrella-beach"></i>
                        </div>
                        <div class="stat-number" id="totalFerie">0</div>
                        <div class="stat-label">Ferie</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="color: var(--danger);">
                            <i class="fas fa-procedures"></i>
                        </div>
                        <div class="stat-number" id="totalMalattia">0</div>
                        <div class="stat-label">Malattia</div>
                    </div>
                </div>
                
                <!-- Tabella giornate -->
                <div class="content-card">
                    <div class="card-header">
                        <h3><i class="fas fa-list"></i> Registro Giornate</h3>
                        <div style="width: 300px;">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="giornateSearch" placeholder="Cerca per note, utente...">
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="data-table-wrapper">
                            <table class="data-table" id="giornateTable">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Utente</th>
                                        <th>Ore Lavoro</th>
                                        <th>Straordinario</th>
                                        <th>Permesso</th>
                                        <th>Ferie</th>
                                        <th>Malattia</th>
                                        <th>Cantiere</th>
                                        <th>Totale Ore</th>
                                        <th>Note</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="giornateTableBody">
                                    <!-- Giornate caricate dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                        <div id="giornateLoading" class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Caricamento giornate lavorative...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modale per aggiungere/modificare giornata -->
    <div class="modal" id="giornataModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="giornataModalTitle"><i class="fas fa-plus"></i> Nuova Giornata Lavorativa</h3>
                <button class="modal-close" id="closeGiornataModal">&times;</button>
            </div>
            <form id="giornataForm">
                <div class="modal-body">
                    <div id="giornataAlert" class="alert hidden"></div>
                    <input type="hidden" id="giornataId">
                    
                    <div class="row">
                        <div class="form-group">
                            <label for="giornataData">Data *</label>
                            <input type="date" id="giornataData" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="giornataUtente">Utente *</label>
                            <select id="giornataUtente" required>
                                <option value="">Seleziona utente...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="form-group">
                            <label for="giornataOreLavoro">Ore Lavoro *</label>
                            <input type="number" id="giornataOreLavoro" step="0.5" min="0" max="24" placeholder="8" required>
                            <small class="small-text">Ore normali lavorate</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="giornataStraordinario">Straordinario</label>
                            <input type="number" id="giornataStraordinario" step="0.5" min="0" max="24" placeholder="0">
                            <small class="small-text">Ore straordinario</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="form-group">
                            <label for="giornataPermesso">Permesso</label>
                            <input type="number" id="giornataPermesso" step="0.5" min="0" max="24" placeholder="0">
                            <small class="small-text">Ore di permesso</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="giornataFerie">Ferie</label>
                            <input type="number" id="giornataFerie" step="0.5" min="0" max="24" placeholder="0">
                            <small class="small-text">Ore di ferie</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="form-group">
                            <label for="giornataMalattia">Malattia</label>
                            <input type="number" id="giornataMalattia" step="0.5" min="0" max="24" placeholder="0">
                            <small class="small-text">Ore di malattia</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="giornataCantiere">Cantiere</label>
                            <select id="giornataCantiere">
                                <option value="">Nessun cantiere</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="giornataNote">Note</label>
                        <textarea id="giornataNote" rows="3" placeholder="Descrizione del lavoro svolto..."></textarea>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Totale ore giornaliere:</strong> <span id="totaleOrePreview">0</span> ore
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelGiornata">Annulla</button>
                    <button type="submit" class="btn btn-primary" id="submitGiornata">
                        <i class="fas fa-save"></i>
                        Salva Giornata
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Includi lo script della sidebar -->
    <script src="scripts/loadSidebar.js"></script>
    
    <script>
        // Firebase Configuration (caricata dal file JSON)
        let firebaseConfig = null;
        let auth = null;
        let db = null;
        
        // Carica la configurazione Firebase dal file JSON
        async function loadFirebaseConfig() {
            try {
                const response = await fetch('firebase_config.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                firebaseConfig = await response.json();
                
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                
                console.log('Firebase configurato correttamente');
                return true;
            } catch (error) {
                console.error('Errore nel caricamento della configurazione Firebase:', error);
                showAlert('error', 'Errore nel caricamento della configurazione. Controlla il file firebase_config.json');
                return false;
            }
        }
        
        // Current user data
        let currentUser = null;
        let currentUserData = null;
        let allGiornate = [];
        let allUsers = [];
        let allCantieri = [];
        let currentFilters = {
            mese: 'current',
            anno: new Date().getFullYear().toString(),
            utente: 'all',
            cantiere: 'all'
        };
        
        // DOM elements
        const dashboardPage = document.getElementById('dashboardPage');
        const logoutBtn = document.getElementById('logoutBtn');
        const userDropdownToggle = document.getElementById('userDropdownToggle');
        const userDropdown = document.getElementById('userDropdown');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        const userAvatar = document.getElementById('userAvatar');
        const alertContainer = document.getElementById('alertContainer');
        
        // Work page elements
        const addGiornataBtn = document.getElementById('addGiornataBtn');
        const giornateSearch = document.getElementById('giornateSearch');
        const giornateTableBody = document.getElementById('giornateTableBody');
        const giornateLoading = document.getElementById('giornateLoading');
        
        // Stats elements
        const totalOre = document.getElementById('totalOre');
        const totalStraordinario = document.getElementById('totalStraordinario');
        const totalFerie = document.getElementById('totalFerie');
        const totalMalattia = document.getElementById('totalMalattia');
        
        // Filter elements
        const filterMese = document.getElementById('filterMese');
        const filterAnno = document.getElementById('filterAnno');
        const filterUtente = document.getElementById('filterUtente');
        const filterCantiere = document.getElementById('filterCantiere');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const resetFiltersBtn = document.getElementById('resetFiltersBtn');
        
        // Modals
        const giornataModal = document.getElementById('giornataModal');
        const closeGiornataModal = document.getElementById('closeGiornataModal');
        const cancelGiornata = document.getElementById('cancelGiornata');
        const giornataForm = document.getElementById('giornataForm');
        const giornataAlert = document.getElementById('giornataAlert');
        const giornataModalTitle = document.getElementById('giornataModalTitle');
        const totaleOrePreview = document.getElementById('totaleOrePreview');
        
        // Helper functions
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }
        
        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'info' ? 'info-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        function showModalAlert(container, type, message) {
            container.textContent = message;
            container.className = `alert alert-${type}`;
            container.classList.remove('hidden');
        }
        
        // Initialize the application
        async function initApp() {
            // Carica la configurazione Firebase
            const configLoaded = await loadFirebaseConfig();
            if (!configLoaded) {
                return;
            }
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserData(user.uid);
                    showDashboard();
                } else {
                    window.location.href = 'index.html';
                }
            });
            
            // Event listeners
            logoutBtn.addEventListener('click', handleLogout);
            userDropdownToggle.addEventListener('click', toggleUserDropdown);
            
            document.addEventListener('click', (e) => {
                if (!userDropdownToggle.contains(e.target) && !userDropdown.contains(e.target)) {
                    userDropdown.classList.remove('show');
                }
            });
            
            // Work page events
            addGiornataBtn.addEventListener('click', () => {
                giornataModalTitle.innerHTML = '<i class="fas fa-plus"></i> Nuova Giornata Lavorativa';
                giornataForm.reset();
                giornataAlert.classList.add('hidden');
                giornataModal.classList.add('show');
                updateOrePreview();
            });
            
            giornateSearch?.addEventListener('input', filterGiornate);
            
            // Filter events
            applyFiltersBtn.addEventListener('click', applyFilters);
            resetFiltersBtn.addEventListener('click', resetFilters);
            
            // Giornata modal events
            closeGiornataModal.addEventListener('click', () => {
                giornataModal.classList.remove('show');
            });
            
            cancelGiornata.addEventListener('click', () => {
                giornataModal.classList.remove('show');
            });
            
            giornataForm.addEventListener('submit', saveGiornata);
            
            // Update ore preview
            ['giornataOreLavoro', 'giornataStraordinario', 'giornataPermesso', 'giornataFerie', 'giornataMalattia']
                .forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', updateOrePreview);
                    }
                });
        }
        
        // Show dashboard
        function showDashboard() {
            dashboardPage.style.display = 'flex';
            updateUserDisplay();
            initFilters();
            loadUsers();
            loadCantieri();
            loadGiornate();
        }
        
        // Load user data
        async function loadUserData(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    currentUserData = userDoc.data();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        // Update user display
        function updateUserDisplay() {
            if (!currentUserData) return;
            
            userName.textContent = currentUserData.name;
            userRole.textContent = currentUserData.role;
            userAvatar.textContent = getInitials(currentUserData.name);
        }
        
        // Handle logout
        function handleLogout(e) {
            e.preventDefault();
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            });
        }
        
        // Toggle user dropdown
        function toggleUserDropdown() {
            userDropdown.classList.toggle('show');
        }
        
        // ===== WORK PAGE FUNCTIONS =====
        
        // Initialize filters
        function initFilters() {
            const currentYear = new Date().getFullYear();
            const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');
            
            // Populate years
            filterAnno.innerHTML = '';
            for (let year = 2020; year <= currentYear + 2; year++) {
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = year.toString();
                if (year === currentYear) {
                    option.selected = true;
                }
                filterAnno.appendChild(option);
            }
            
            // Set current month
            filterMese.value = currentMonth;
            
            currentFilters.anno = currentYear.toString();
            currentFilters.mese = currentMonth;
        }
        
        // Load users
        async function loadUsers() {
            try {
                const usersSnapshot = await db.collection('users').get();
                allUsers = [];
                filterUtente.innerHTML = '<option value="all">Tutti gli utenti</option>';
                const utenteSelect = document.getElementById('giornataUtente');
                utenteSelect.innerHTML = '<option value="">Seleziona utente...</option>';
                
                usersSnapshot.forEach((doc) => {
                    const user = doc.data();
                    const userId = doc.id;
                    
                    allUsers.push({ id: userId, ...user });
                    
                    const filterOption = document.createElement('option');
                    filterOption.value = userId;
                    filterOption.textContent = `${user.name} (${user.email})`;
                    filterUtente.appendChild(filterOption);
                    
                    const formOption = document.createElement('option');
                    formOption.value = userId;
                    formOption.textContent = `${user.name} - ${user.email}`;
                    utenteSelect.appendChild(formOption);
                });
            } catch (error) {
                console.error('Error loading users:', error);
                showAlert('error', 'Errore nel caricamento degli utenti');
            }
        }
        
        // Load cantieri
        async function loadCantieri() {
            try {
                const cantieriSnapshot = await db.collection('cantieri').get();
                allCantieri = [];
                filterCantiere.innerHTML = '<option value="all">Tutti i cantieri</option><option value="none">Nessun cantiere</option>';
                const cantiereSelect = document.getElementById('giornataCantiere');
                cantiereSelect.innerHTML = '<option value="">Nessun cantiere</option>';
                
                cantieriSnapshot.forEach((doc) => {
                    const cantiere = doc.data();
                    const cantiereId = doc.id;
                    
                    allCantieri.push({ id: cantiereId, ...cantiere });
                    
                    const filterOption = document.createElement('option');
                    filterOption.value = cantiereId;
                    filterOption.textContent = cantiere.nome;
                    filterCantiere.appendChild(filterOption);
                    
                    const formOption = document.createElement('option');
                    formOption.value = cantiereId;
                    formOption.textContent = cantiere.nome;
                    cantiereSelect.appendChild(formOption);
                });
            } catch (error) {
                console.error('Error loading cantieri:', error);
                showAlert('error', 'Errore nel caricamento dei cantieri');
            }
        }
        
        // Load giornate
        async function loadGiornate() {
            giornateTableBody.innerHTML = '';
            giornateLoading.classList.remove('hidden');
            
            try {
                // Build query based on filters
                let query = db.collection('giornate_lavorative');
                
                // Date filter
                if (currentFilters.mese && currentFilters.mese !== 'all' && currentFilters.anno) {
                    const year = parseInt(currentFilters.anno);
                    const month = currentFilters.mese === 'current' ? 
                        (new Date().getMonth() + 1) : parseInt(currentFilters.mese);
                    
                    const startDate = `${year}-${month.toString().padStart(2, '0')}-01`;
                    const endDate = `${year}-${month.toString().padStart(2, '0')}-${new Date(year, month, 0).getDate()}`;
                    
                    query = query.where('data', '>=', startDate)
                                 .where('data', '<=', endDate);
                } else if (currentFilters.mese === 'all' && currentFilters.anno) {
                    // Filter by year only
                    const year = parseInt(currentFilters.anno);
                    query = query.where('data', '>=', `${year}-01-01`)
                                 .where('data', '<=', `${year}-12-31`);
                }
                
                // User filter
                if (currentFilters.utente !== 'all') {
                    query = query.where('utenteId', '==', currentFilters.utente);
                }
                
                // Cantiere filter
                if (currentFilters.cantiere !== 'all') {
                    if (currentFilters.cantiere === 'none') {
                        query = query.where('cantiereId', '==', null);
                    } else {
                        query = query.where('cantiereId', '==', currentFilters.cantiere);
                    }
                }
                
                const giornateSnapshot = await query.orderBy('data', 'desc').get();
                allGiornate = [];
                
                let totalOreLavoro = 0;
                let totalOreStraordinario = 0;
                let totalOreFerie = 0;
                let totalOreMalattia = 0;
                
                giornateSnapshot.forEach((doc) => {
                    const giornata = doc.data();
                    const giornataId = doc.id;
                    
                    allGiornate.push({ id: giornataId, ...giornata });
                    
                    const user = allUsers.find(u => u.id === giornata.utenteId) || {};
                    const cantiere = allCantieri.find(c => c.id === giornata.cantiereId) || {};
                    
                    const oreLavoro = parseFloat(giornata.ore_lavoro) || 0;
                    const oreStraordinario = parseFloat(giornata.ore_straordinario) || 0;
                    const orePermesso = parseFloat(giornata.ore_permesso) || 0;
                    const oreFerie = parseFloat(giornata.ore_ferie) || 0;
                    const oreMalattia = parseFloat(giornata.ore_malattia) || 0;
                    const totaleOre = oreLavoro + oreStraordinario + orePermesso + oreFerie + oreMalattia;
                    
                    // Update totals
                    totalOreLavoro += oreLavoro;
                    totalOreStraordinario += oreStraordinario;
                    totalOreFerie += oreFerie;
                    totalOreMalattia += oreMalattia;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(giornata.data)}</td>
                        <td>${user.name || 'Utente sconosciuto'}</td>
                        <td>${oreLavoro.toFixed(1)}</td>
                        <td>${oreStraordinario.toFixed(1)}</td>
                        <td>${orePermesso.toFixed(1)}</td>
                        <td>${oreFerie.toFixed(1)}</td>
                        <td>${oreMalattia.toFixed(1)}</td>
                        <td>${cantiere.nome || '-'}</td>
                        <td><strong>${totaleOre.toFixed(1)}</strong></td>
                        <td>${giornata.note || ''}</td>
                        <td>
                            <button class="btn btn-icon edit-giornata-btn" data-id="${giornataId}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-icon delete-giornata-btn" data-id="${giornataId}" data-date="${giornata.data}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    giornateTableBody.appendChild(row);
                });
                
                // Add event listeners
                document.querySelectorAll('.edit-giornata-btn').forEach(btn => {
                    btn.addEventListener('click', () => editGiornata(btn.getAttribute('data-id')));
                });
                
                document.querySelectorAll('.delete-giornata-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteGiornata(
                        btn.getAttribute('data-id'),
                        btn.getAttribute('data-date')
                    ));
                });
                
                // Update statistics
                totalOre.textContent = totalOreLavoro.toFixed(1);
                totalStraordinario.textContent = totalOreStraordinario.toFixed(1);
                totalFerie.textContent = totalOreFerie.toFixed(1);
                totalMalattia.textContent = totalOreMalattia.toFixed(1);
                
            } catch (error) {
                console.error('Error loading giornate:', error);
                showAlert('error', 'Errore nel caricamento delle giornate');
            } finally {
                giornateLoading.classList.add('hidden');
            }
        }
        
        // Filter giornate
        function filterGiornate() {
            const searchTerm = giornateSearch.value.toLowerCase();
            const rows = giornateTableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // Apply filters
        function applyFilters() {
            currentFilters.mese = filterMese.value;
            currentFilters.anno = filterAnno.value;
            currentFilters.utente = filterUtente.value;
            currentFilters.cantiere = filterCantiere.value;
            
            loadGiornate();
        }
        
        // Reset filters
        function resetFilters() {
            const currentYear = new Date().getFullYear();
            const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');
            
            filterMese.value = currentMonth;
            filterAnno.value = currentYear.toString();
            filterUtente.value = 'all';
            filterCantiere.value = 'all';
            
            applyFilters();
        }
        
        // Edit giornata
        async function editGiornata(giornataId) {
            try {
                const giornataDoc = await db.collection('giornate_lavorative').doc(giornataId).get();
                if (!giornataDoc.exists) {
                    showAlert('error', 'Giornata non trovata');
                    return;
                }
                
                const giornata = giornataDoc.data();
                
                document.getElementById('giornataId').value = giornataId;
                document.getElementById('giornataData').value = giornata.data || '';
                document.getElementById('giornataUtente').value = giornata.utenteId || '';
                document.getElementById('giornataOreLavoro').value = giornata.ore_lavoro || '';
                document.getElementById('giornataStraordinario').value = giornata.ore_straordinario || '';
                document.getElementById('giornataPermesso').value = giornata.ore_permesso || '';
                document.getElementById('giornataFerie').value = giornata.ore_ferie || '';
                document.getElementById('giornataMalattia').value = giornata.ore_malattia || '';
                document.getElementById('giornataCantiere').value = giornata.cantiereId || '';
                document.getElementById('giornataNote').value = giornata.note || '';
                
                giornataModalTitle.innerHTML = '<i class="fas fa-edit"></i> Modifica Giornata';
                giornataAlert.classList.add('hidden');
                giornataModal.classList.add('show');
                updateOrePreview();
            } catch (error) {
                console.error('Error loading giornata for edit:', error);
                showAlert('error', 'Errore nel caricamento della giornata');
            }
        }
        
        // Save giornata
        async function saveGiornata(e) {
            e.preventDefault();
            
            const giornataId = document.getElementById('giornataId').value;
            const data = document.getElementById('giornataData').value;
            const utenteId = document.getElementById('giornataUtente').value;
            const oreLavoro = document.getElementById('giornataOreLavoro').value;
            const oreStraordinario = document.getElementById('giornataStraordinario').value || 0;
            const orePermesso = document.getElementById('giornataPermesso').value || 0;
            const oreFerie = document.getElementById('giornataFerie').value || 0;
            const oreMalattia = document.getElementById('giornataMalattia').value || 0;
            const cantiereId = document.getElementById('giornataCantiere').value || null;
            const note = document.getElementById('giornataNote').value;
            
            // Validation
            if (!data || !utenteId || !oreLavoro) {
                showModalAlert(giornataAlert, 'error', 'Data, utente e ore lavoro sono obbligatorie');
                return;
            }
            
            const selectedUser = allUsers.find(u => u.id === utenteId);
            if (!selectedUser) {
                showModalAlert(giornataAlert, 'error', 'Utente non valido');
                return;
            }
            
            const submitBtn = document.getElementById('submitGiornata');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvataggio...';
            submitBtn.disabled = true;
            
            try {
                const giornataData = {
                    data: data,
                    utenteId: utenteId,
                    utenteEmail: selectedUser.email,
                    utenteNome: selectedUser.name,
                    ore_lavoro: parseFloat(oreLavoro) || 0,
                    ore_straordinario: parseFloat(oreStraordinario) || 0,
                    ore_permesso: parseFloat(orePermesso) || 0,
                    ore_ferie: parseFloat(oreFerie) || 0,
                    ore_malattia: parseFloat(oreMalattia) || 0,
                    cantiereId: cantiereId,
                    note: note || '',
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.uid
                };
                
                // Get cantiere name if exists
                if (cantiereId) {
                    const cantiere = allCantieri.find(c => c.id === cantiereId);
                    if (cantiere) {
                        giornataData.cantiereNome = cantiere.nome;
                    }
                }
                
                if (giornataId) {
                    await db.collection('giornate_lavorative').doc(giornataId).update(giornataData);
                } else {
                    giornataData.createdAt = new Date().toISOString();
                    giornataData.createdBy = currentUser.uid;
                    await db.collection('giornate_lavorative').add(giornataData);
                }
                
                giornataModal.classList.remove('show');
                loadGiornate();
                showAlert('success', giornataId ? 'Giornata aggiornata!' : 'Giornata creata!');
            } catch (error) {
                console.error('Error saving giornata:', error);
                showModalAlert(giornataAlert, 'error', 'Errore durante il salvataggio');
            } finally {
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Salva Giornata';
                submitBtn.disabled = false;
            }
        }
        
        // Delete giornata
        async function deleteGiornata(giornataId, data) {
            if (!confirm(`Sei sicuro di voler eliminare la giornata del ${formatDate(data)}?`)) {
                return;
            }
            
            try {
                await db.collection('giornate_lavorative').doc(giornataId).delete();
                loadGiornate();
                showAlert('success', 'Giornata eliminata!');
            } catch (error) {
                console.error('Error deleting giornata:', error);
                showAlert('error', 'Errore durante l\'eliminazione');
            }
        }
        
        // Update ore preview
        function updateOrePreview() {
            const oreLavoro = parseFloat(document.getElementById('giornataOreLavoro').value) || 0;
            const oreStraordinario = parseFloat(document.getElementById('giornataStraordinario').value) || 0;
            const orePermesso = parseFloat(document.getElementById('giornataPermesso').value) || 0;
            const oreFerie = parseFloat(document.getElementById('giornataFerie').value) || 0;
            const oreMalattia = parseFloat(document.getElementById('giornataMalattia').value) || 0;
            
            const totale = oreLavoro + oreStraordinario + orePermesso + oreFerie + oreMalattia;
            totaleOrePreview.textContent = totale.toFixed(1);
        }
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
            <!-- Includi il footer -->
    <script>
        // Carica il footer
        fetch('footer.html')
            .then(response => response.text())
            .then(data => {
                document.body.insertAdjacentHTML('beforeend', data);
            })
            .catch(error => {
                console.error('Errore nel caricamento del footer:', error);
                // Fallback: crea un footer minimale se il caricamento fallisce
                const fallbackFooter = document.createElement('footer');
                fallbackFooter.className = 'dashboard-footer';
                fallbackFooter.innerHTML = `
                    <div class="footer-container">
                        <p>&copy; ${new Date().getFullYear()} Marocco&Cuffari Ristauri Edili</p>
                        <p class="developer-credit">Sviluppato da Cristian Felice Cuffari</p>
                    </div>
                `;
                document.body.appendChild(fallbackFooter);
            });
    </script>
</body>
</html>