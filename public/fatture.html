<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marocco&Cuffari - Gestione Fatture</title>
    <link rel="stylesheet" href="style.css">

        
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

</head>
<body>
    <div class="dashboard-page" id="dashboardPage">
        <!-- Navbar -->
        <nav class="navbar">
            <div class="navbar-container">
                <div class="navbar-brand">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="logo">
                        <i class="fas fa-hard-hat"></i>
                        <span>Marocco<span class="logo-highlight">&</span>Cuffari</span>
                    </div>
                </div>
                
                <div class="navbar-user">
                    <div class="user-info" id="userDropdownToggle">
                        <div class="user-avatar" id="userAvatar">
                            <!-- Initials will be set by JavaScript -->
                        </div>
                        <div class="user-details">
                            <div class="user-name" id="userName">Caricamento...</div>
                            <div class="user-role" id="userRole">Caricamento...</div>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    
                    <div class="user-dropdown" id="userDropdown">
                        <a href="index.html">
                            <i class="fas fa-home"></i>
                            Dashboard Principale
                        </a>
                        <a href="cantieri.html">
                            <i class="fas fa-hard-hat"></i>
                            Gestione Cantieri
                        </a>
                        <a href="lavoro.html">
                            <i class="fas fa-calendar-alt"></i>
                            Giornate Lavorative
                        </a>
                        <a href="preventivi.html">
                            <i class="fas fa-file-contract"></i>
                            Preventivi
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            Esci
                        </a>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Main Container -->
        <div class="main-container">
            <!-- La sidebar verrà caricata dinamicamente -->
            
            <div class="page-content" id="mainContent">
                <!-- Alert Container -->
                <div id="alertContainer"></div>
                
                <!-- Page Header -->
                <div class="page-header">
                    <h1><i class="fas fa-file-invoice"></i> Gestione Fatture</h1>
                    <div class="header-actions">
                        <button class="btn btn-success" id="addFatturaBtn">
                            <i class="fas fa-plus"></i>
                            Nuova Fattura
                        </button>
                    </div>
                </div>
                
                <!-- Stats Overview -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="color: var(--accent);">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div class="stat-number" id="totalFatture">0</div>
                        <div class="stat-label">Fatture Totali</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="color: var(--success);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-number" id="fatturePagate">0</div>
                        <div class="stat-label">Pagate</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="color: var(--warning);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-number" id="fattureScadute">0</div>
                        <div class="stat-label">Scadute</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="color: var(--danger);">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="stat-number" id="totaleScaduto">€0</div>
                        <div class="stat-label">Importo Scaduto</div>
                    </div>
                </div>
                
                <!-- Filtri -->
                <div class="content-card">
                    <div class="card-header">
                        <h3><i class="fas fa-filter"></i> Filtri</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="form-group">
                                <label for="filterStato">Stato</label>
                                <select id="filterStato" class="form-control">
                                    <option value="all">Tutti gli stati</option>
                                    <option value="pagata">Pagate</option>
                                    <option value="da_pagare">Da Pagare</option>
                                    <option value="scaduta">Scadute</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="filterMese">Mese Emissione</label>
                                <select id="filterMese" class="form-control">
                                    <option value="all">Tutti i mesi</option>
                                    <option value="01">Gennaio</option>
                                    <option value="02">Febbraio</option>
                                    <option value="03">Marzo</option>
                                    <option value="04">Aprile</option>
                                    <option value="05">Maggio</option>
                                    <option value="06">Giugno</option>
                                    <option value="07">Luglio</option>
                                    <option value="08">Agosto</option>
                                    <option value="09">Settembre</option>
                                    <option value="10">Ottobre</option>
                                    <option value="11">Novembre</option>
                                    <option value="12">Dicembre</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="filterAnno">Anno</label>
                                <select id="filterAnno" class="form-control">
                                    <!-- Popolato dinamicamente -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="filterCliente">Cliente</label>
                                <input type="text" id="filterCliente" placeholder="Cerca cliente..." class="form-control">
                            </div>
                            
                            <div class="form-group" style="align-self: flex-end;">
                                <button class="btn btn-primary" id="applyFiltersBtn">
                                    <i class="fas fa-search"></i>
                                    Applica Filtri
                                </button>
                                <button class="btn btn-secondary" id="resetFiltersBtn">
                                    <i class="fas fa-redo"></i>
                                    Reset
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabella fatture -->
                <div class="content-card">
                    <div class="card-header">
                        <h3><i class="fas fa-list"></i> Elenco Fatture</h3>
                        <div style="width: 300px;">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="fattureSearch" placeholder="Cerca fatture...">
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="data-table-wrapper">
                            <table class="data-table" id="fattureTable">
                                <thead>
                                    <tr>
                                        <th>Numero</th>
                                        <th>Data</th>
                                        <th>Cliente</th>
                                        <th>Importo</th>
                                        <th>Scadenza</th>
                                        <th>Stato</th>
                                        <th>Cantiere</th>
                                        <th>File</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="fattureTableBody">
                                    <!-- Fatture caricate dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                        <div id="fattureLoading" class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Caricamento fatture...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modale per aggiungere/modificare fattura -->
    <div class="modal" id="fatturaModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="fatturaModalTitle"><i class="fas fa-plus"></i> Nuova Fattura</h3>
                <button class="modal-close" id="closeFatturaModal">&times;</button>
            </div>
            <form id="fatturaForm">
                <div class="modal-body">
                    <div id="fatturaAlert" class="alert hidden"></div>
                    <input type="hidden" id="fatturaId">
                    
                    <div class="row">
                        <div class="form-group">
                            <label for="fatturaNumero">Numero Fattura *</label>
                            <input type="text" id="fatturaNumero" placeholder="FATT/2024/001" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="fatturaData">Data Emissione *</label>
                            <input type="date" id="fatturaData" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="form-group">
                            <label for="fatturaCliente">Cliente *</label>
                            <input type="text" id="fatturaCliente" placeholder="Nome cliente" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="fatturaImporto">Importo (€) *</label>
                            <input type="number" id="fatturaImporto" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="form-group">
                            <label for="fatturaScadenza">Data Scadenza</label>
                            <input type="date" id="fatturaScadenza">
                        </div>
                        
                        <div class="form-group">
                            <label for="fatturaStato">Stato *</label>
                            <select id="fatturaStato" required>
                                <option value="da_pagare">Da Pagare</option>
                                <option value="pagata">Pagata</option>
                                <option value="parziale">Pagamento Parziale</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="form-group">
                            <label for="fatturaCantiere">Cantiere Associato</label>
                            <select id="fatturaCantiere">
                                <option value="">Nessun cantiere</option>
                                <!-- Popolato dinamicamente -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="fatturaPagamento">Metodo Pagamento</label>
                            <select id="fatturaPagamento">
                                <option value="">Non specificato</option>
                                <option value="bonifico">Bonifico Bancario</option>
                                <option value="contanti">Contanti</option>
                                <option value="assegno">Assegno</option>
                                <option value="carta">Carta di Credito</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="fatturaNote">Note</label>
                        <textarea id="fatturaNote" rows="3" placeholder="Note aggiuntive..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="fatturaFile">File Fattura (PDF)</label>
                        <div class="file-upload-container" id="fatturaFileContainer">
                            <div class="file-upload-icon">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <div class="file-upload-text">
                                <h4>Trascina qui il file PDF</h4>
                                <p>oppure clicca per selezionare</p>
                                <input type="file" id="fatturaFileInput" accept=".pdf" style="display: none;">
                                <button type="button" class="btn btn-primary" id="selectFatturaFileBtn">
                                    <i class="fas fa-folder-open"></i>
                                    Seleziona File PDF
                                </button>
                            </div>
                        </div>
                        <div id="fatturaFilePreview" class="file-preview hidden">
                            <!-- Anteprima file -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelFattura">Annulla</button>
                    <button type="submit" class="btn btn-primary" id="submitFattura">
                        <i class="fas fa-save"></i>
                        Salva Fattura
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="scripts/loadSidebar.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA7JiQrPYfvkRWZtdXQFw2Hj2LK0aidXYs",
            authDomain: "work-tracker-v120400.firebaseapp.com",
            projectId: "work-tracker-v120400",
            storageBucket: "work-tracker-v120400.firebasestorage.app",
            messagingSenderId: "437459935839",
            appId: "1:437459935839:web:cb0b54608314dcb25731ea",
            measurementId: "G-2LPKL9WREX"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Variabili globali
        let currentUser = null;
        let currentUserData = null;
        let allFatture = [];
        let allCantieri = [];
        let currentFilters = {
            stato: 'all',
            mese: 'all',
            anno: new Date().getFullYear().toString(),
            cliente: ''
        };
        
        // DOM elements
        const addFatturaBtn = document.getElementById('addFatturaBtn');
        const fattureTableBody = document.getElementById('fattureTableBody');
        const fatturaModal = document.getElementById('fatturaModal');
        const fatturaForm = document.getElementById('fatturaForm');
        const fatturaFileInput = document.getElementById('fatturaFileInput');
        const selectFatturaFileBtn = document.getElementById('selectFatturaFileBtn');
        const fatturaFileContainer = document.getElementById('fatturaFileContainer');
        const fatturaFilePreview = document.getElementById('fatturaFilePreview');
        const closeFatturaModal = document.getElementById('closeFatturaModal');
        const cancelFattura = document.getElementById('cancelFattura');
        
        // Stats elements
        const totalFatture = document.getElementById('totalFatture');
        const fatturePagate = document.getElementById('fatturePagate');
        const fattureScadute = document.getElementById('fattureScadute');
        const totaleScaduto = document.getElementById('totaleScaduto');
        
        // Filter elements
        const filterStato = document.getElementById('filterStato');
        const filterMese = document.getElementById('filterMese');
        const filterAnno = document.getElementById('filterAnno');
        const filterCliente = document.getElementById('filterCliente');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const resetFiltersBtn = document.getElementById('resetFiltersBtn');
        const fattureSearch = document.getElementById('fattureSearch');
        
        // Initialize app
        function initApp() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserData(user.uid);
                    showDashboard();
                } else {
                    window.location.href = 'index.html';
                }
            });
            
            // Event listeners
            addFatturaBtn.addEventListener('click', () => {
                document.getElementById('fatturaModalTitle').innerHTML = '<i class="fas fa-plus"></i> Nuova Fattura';
                fatturaForm.reset();
                fatturaFilePreview.classList.add('hidden');
                document.getElementById('fatturaAlert').classList.add('hidden');
                document.getElementById('fatturaId').value = '';
                fatturaModal.classList.add('show');
                loadCantieriDropdown();
            });
            
            closeFatturaModal.addEventListener('click', () => {
                fatturaModal.classList.remove('show');
            });
            
            cancelFattura.addEventListener('click', () => {
                fatturaModal.classList.remove('show');
            });
            
            fatturaForm.addEventListener('submit', saveFattura);
            selectFatturaFileBtn.addEventListener('click', () => fatturaFileInput.click());
            
            // Drag & drop per file
            setupFileDragDrop(fatturaFileContainer, fatturaFileInput);
            
            // Filtri
            applyFiltersBtn.addEventListener('click', applyFilters);
            resetFiltersBtn.addEventListener('click', resetFilters);
            fattureSearch.addEventListener('input', filterFatture);
            
            // Inizializza filtri anno
            initYearFilter();
        }
        
        function showDashboard() {
            updateUserDisplay();
            loadCantieri();
            loadFatture();
        }
        
        function loadUserData(uid) {
            return db.collection('users').doc(uid).get().then(doc => {
                if (doc.exists) {
                    currentUserData = doc.data();
                }
            });
        }
        
        function updateUserDisplay() {
            if (currentUserData) {
                document.getElementById('userName').textContent = currentUserData.name;
                document.getElementById('userRole').textContent = currentUserData.role;
                document.getElementById('userAvatar').textContent = 
                    currentUserData.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            }
        }
        
        // Funzioni per gestione file
        function setupFileDragDrop(container, fileInput) {
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                container.classList.add('dragover');
            });
            
            container.addEventListener('dragleave', () => {
                container.classList.remove('dragover');
            });
            
            container.addEventListener('drop', (e) => {
                e.preventDefault();
                container.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    if (file.type === 'application/pdf') {
                        showFilePreview(file);
                    } else {
                        showModalAlert('error', 'Si prega di selezionare un file PDF');
                    }
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    showFilePreview(e.target.files[0]);
                }
            });
        }
        
        function showFilePreview(file) {
            fatturaFilePreview.classList.remove('hidden');
            fatturaFilePreview.innerHTML = `
                <i class="fas fa-file-pdf"></i>
                <div style="flex: 1;">
                    <strong>${file.name}</strong><br>
                    <small>${(file.size / 1024).toFixed(2)} KB</small>
                </div>
                <button type="button" class="btn btn-icon" onclick="clearFilePreview()">
                    <i class="fas fa-times"></i>
                </button>
            `;
        }
        
        function clearFilePreview() {
            fatturaFileInput.value = '';
            fatturaFilePreview.classList.add('hidden');
        }
        
        // Carica cantieri
        async function loadCantieri() {
            try {
                const snapshot = await db.collection('cantieri').get();
                allCantieri = [];
                snapshot.forEach(doc => {
                    allCantieri.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Error loading cantieri:', error);
            }
        }
        
        function loadCantieriDropdown() {
            const select = document.getElementById('fatturaCantiere');
            select.innerHTML = '<option value="">Nessun cantiere</option>';
            allCantieri.forEach(cantiere => {
                const option = document.createElement('option');
                option.value = cantiere.id;
                option.textContent = cantiere.nome;
                select.appendChild(option);
            });
        }
        
        // Carica fatture
        async function loadFatture() {
            fattureTableBody.innerHTML = '';
            document.getElementById('fattureLoading').classList.remove('hidden');
            
            try {
                let query = db.collection('fatture');
                
                // Applica filtri
                if (currentFilters.stato !== 'all') {
                    query = query.where('stato', '==', currentFilters.stato);
                }
                
                if (currentFilters.mese !== 'all' && currentFilters.anno) {
                    const startDate = `${currentFilters.anno}-${currentFilters.mese}-01`;
                    const endDate = `${currentFilters.anno}-${currentFilters.mese}-31`;
                    query = query.where('data', '>=', startDate).where('data', '<=', endDate);
                }
                
                if (currentFilters.cliente) {
                    query = query.where('cliente', '>=', currentFilters.cliente)
                                 .where('cliente', '<=', currentFilters.cliente + '\uf8ff');
                }
                
                const snapshot = await query.orderBy('data', 'desc').get();
                allFatture = [];
                
                let totalPagate = 0;
                let totalScadute = 0;
                let totaleImportoScaduto = 0;
                
                snapshot.forEach(doc => {
                    const fattura = doc.data();
                    const fatturaId = doc.id;
                    allFatture.push({ id: fatturaId, ...fattura });
                    
                    // Calcola statistiche
                    if (fattura.stato === 'pagata') totalPagate++;
                    
                    const scadenza = new Date(fattura.scadenza || fattura.data);
                    const oggi = new Date();
                    if (scadenza < oggi && fattura.stato !== 'pagata') {
                        totalScadute++;
                        totaleImportoScaduto += parseFloat(fattura.importo) || 0;
                    }
                    
                    // Crea riga tabella
                    const row = document.createElement('tr');
                    const scaduto = scadenza < oggi && fattura.stato !== 'pagata';
                    
                    let statoBadge = '';
                    if (fattura.stato === 'pagata') {
                        statoBadge = '<span class="badge-paid">Pagata</span>';
                    } else if (scaduto) {
                        statoBadge = '<span class="badge-overdue">Scaduta</span>';
                    } else {
                        statoBadge = '<span class="badge-unpaid">Da Pagare</span>';
                    }
                    
                    row.innerHTML = `
                        <td><strong>${fattura.numero || 'N/D'}</strong></td>
                        <td>${formatDate(fattura.data)}</td>
                        <td>${fattura.cliente || ''}</td>
                        <td class="amount">€${parseFloat(fattura.importo || 0).toFixed(2)}</td>
                        <td>${fattura.scadenza ? formatDate(fattura.scadenza) : '-'}</td>
                        <td>${statoBadge}</td>
                        <td>${getCantiereName(fattura.cantiereId) || '-'}</td>
                        <td>
                            ${fattura.fileUrl ? 
                                `<button class="btn btn-icon download-file-btn" data-url="${fattura.fileUrl}" data-name="${fattura.fileName || 'fattura.pdf'}">
                                    <i class="fas fa-download"></i>
                                </button>` : 
                                '<small>Nessun file</small>'}
                        </td>
                        <td>
                            <button class="btn btn-icon edit-fattura-btn" data-id="${fatturaId}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-icon delete-fattura-btn" data-id="${fatturaId}" data-numero="${fattura.numero}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    fattureTableBody.appendChild(row);
                });
                
                // Aggiorna statistiche
                totalFatture.textContent = allFatture.length;
                fatturePagate.textContent = totalPagate;
                fattureScadute.textContent = totalScadute;
                totaleScaduto.textContent = `€${totaleImportoScaduto.toFixed(2)}`;
                
                // Aggiungi event listeners
                document.querySelectorAll('.download-file-btn').forEach(btn => {
                    btn.addEventListener('click', () => downloadFile(
                        btn.getAttribute('data-url'),
                        btn.getAttribute('data-name')
                    ));
                });
                
                document.querySelectorAll('.edit-fattura-btn').forEach(btn => {
                    btn.addEventListener('click', () => editFattura(btn.getAttribute('data-id')));
                });
                
                document.querySelectorAll('.delete-fattura-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteFattura(
                        btn.getAttribute('data-id'),
                        btn.getAttribute('data-numero')
                    ));
                });
                
            } catch (error) {
                console.error('Error loading fatture:', error);
                showAlert('error', 'Errore nel caricamento delle fatture');
            } finally {
                document.getElementById('fattureLoading').classList.add('hidden');
            }
        }
        
        function getCantiereName(cantiereId) {
            if (!cantiereId) return null;
            const cantiere = allCantieri.find(c => c.id === cantiereId);
            return cantiere ? cantiere.nome : null;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString('it-IT');
        }
        
        // Salva fattura
        async function saveFattura(e) {
            e.preventDefault();
            
            const fatturaId = document.getElementById('fatturaId').value;
            const file = fatturaFileInput.files[0];
            
            // Validazione
            if (!file && !fatturaId) {
                showModalAlert(fatturaAlert, 'error', 'Si prega di selezionare un file PDF per la fattura');
                return;
            }
            
            const submitBtn = document.getElementById('submitFattura');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvataggio...';
            submitBtn.disabled = true;
            
            try {
                let fileUrl = '';
                let fileName = '';
                
                // Upload file se presente
                if (file) {
                    const storageRef = storage.ref();
                    const fileRef = storageRef.child(`fatture/${Date.now()}_${file.name}`);
                    await fileRef.put(file);
                    fileUrl = await fileRef.getDownloadURL();
                    fileName = file.name;
                }
                
                // Prepara dati fattura
                const fatturaData = {
                    numero: document.getElementById('fatturaNumero').value,
                    data: document.getElementById('fatturaData').value,
                    cliente: document.getElementById('fatturaCliente').value,
                    importo: parseFloat(document.getElementById('fatturaImporto').value),
                    scadenza: document.getElementById('fatturaScadenza').value || null,
                    stato: document.getElementById('fatturaStato').value,
                    cantiereId: document.getElementById('fatturaCantiere').value || null,
                    pagamento: document.getElementById('fatturaPagamento').value || '',
                    note: document.getElementById('fatturaNote').value || '',
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.uid
                };
                
                // Aggiungi info file se caricato
                if (fileUrl) {
                    fatturaData.fileUrl = fileUrl;
                    fatturaData.fileName = fileName;
                }
                
                // Salva su Firestore
                if (fatturaId) {
                    // Aggiornamento - manteniamo il file esistente se non viene caricato nuovo
                    if (!fileUrl) {
                        // Mantieni il file esistente
                        const existingFattura = allFatture.find(f => f.id === fatturaId);
                        if (existingFattura) {
                            fatturaData.fileUrl = existingFattura.fileUrl;
                            fatturaData.fileName = existingFattura.fileName;
                        }
                    }
                    await db.collection('fatture').doc(fatturaId).update(fatturaData);
                } else {
                    // Nuova fattura
                    fatturaData.createdAt = new Date().toISOString();
                    fatturaData.createdBy = currentUser.uid;
                    await db.collection('fatture').add(fatturaData);
                }
                
                // Chiudi modal e ricarica
                fatturaModal.classList.remove('show');
                loadFatture();
                showAlert('success', fatturaId ? 'Fattura aggiornata!' : 'Fattura creata!');
                
            } catch (error) {
                console.error('Error saving fattura:', error);
                showModalAlert(fatturaAlert, 'error', 'Errore durante il salvataggio');
            } finally {
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Salva Fattura';
                submitBtn.disabled = false;
            }
        }
        
        // Download file
        function downloadFile(url, fileName) {
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Altre funzioni (edit, delete, filtri) simili alla pagina lavoro
        function editFattura(id) {
            const fattura = allFatture.find(f => f.id === id);
            if (!fattura) return;
            
            // Popola form
            document.getElementById('fatturaId').value = id;
            document.getElementById('fatturaNumero').value = fattura.numero;
            document.getElementById('fatturaData').value = fattura.data;
            document.getElementById('fatturaCliente').value = fattura.cliente;
            document.getElementById('fatturaImporto').value = fattura.importo;
            document.getElementById('fatturaScadenza').value = fattura.scadenza || '';
            document.getElementById('fatturaStato').value = fattura.stato;
            document.getElementById('fatturaCantiere').value = fattura.cantiereId || '';
            document.getElementById('fatturaPagamento').value = fattura.pagamento || '';
            document.getElementById('fatturaNote').value = fattura.note || '';
            
            // Mostra preview file esistente
            if (fattura.fileUrl) {
                fatturaFilePreview.classList.remove('hidden');
                fatturaFilePreview.innerHTML = `
                    <i class="fas fa-file-pdf"></i>
                    <div style="flex: 1;">
                        <strong>${fattura.fileName}</strong><br>
                        <small>File già caricato</small>
                    </div>
                    <button type="button" class="btn btn-icon" onclick="clearFilePreview()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            }
            
            document.getElementById('fatturaModalTitle').innerHTML = '<i class="fas fa-edit"></i> Modifica Fattura';
            loadCantieriDropdown();
            fatturaModal.classList.add('show');
        }
        
        async function deleteFattura(id, numero) {
            if (!confirm(`Sei sicuro di voler eliminare la fattura ${numero}?`)) return;
            
            try {
                await db.collection('fatture').doc(id).delete();
                loadFatture();
                showAlert('success', 'Fattura eliminata!');
            } catch (error) {
                console.error('Error deleting fattura:', error);
                showAlert('error', 'Errore durante l\'eliminazione');
            }
        }
        
        function initYearFilter() {
            const currentYear = new Date().getFullYear();
            filterAnno.innerHTML = '';
            for (let year = 2020; year <= currentYear + 2; year++) {
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = year.toString();
                if (year === currentYear) option.selected = true;
                filterAnno.appendChild(option);
            }
        }
        
        function applyFilters() {
            currentFilters.stato = filterStato.value;
            currentFilters.mese = filterMese.value;
            currentFilters.anno = filterAnno.value;
            currentFilters.cliente = filterCliente.value;
            loadFatture();
        }
        
        function resetFilters() {
            filterStato.value = 'all';
            filterMese.value = 'all';
            filterAnno.value = new Date().getFullYear().toString();
            filterCliente.value = '';
            applyFilters();
        }
        
        function filterFatture() {
            const term = fattureSearch.value.toLowerCase();
            const rows = fattureTableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        }
        
        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.getElementById('alertContainer').innerHTML = '';
            document.getElementById('alertContainer').appendChild(alert);
            
            setTimeout(() => alert.remove(), 5000);
        }
        
        function showModalAlert(container, type, message) {
            container.textContent = message;
            container.className = `alert alert-${type}`;
            container.classList.remove('hidden');
        }
        
        // Inizializza app
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
>
    <script>
        // Carica il footer
        fetch('footer.html')
            .then(response => response.text())
            .then(data => {
                document.body.insertAdjacentHTML('beforeend', data);
            })
            .catch(error => {
                console.error('Errore nel caricamento del footer:', error);
                // Fallback: crea un footer minimale se il caricamento fallisce
                const fallbackFooter = document.createElement('footer');
                fallbackFooter.className = 'dashboard-footer';
                fallbackFooter.innerHTML = `
                    <div class="footer-container">
                        <p>&copy; ${new Date().getFullYear()} Marocco&Cuffari Ristauri Edili</p>
                        <p class="developer-credit">Sviluppato da Cristian Felice Cuffari</p>
                    </div>
                `;
                document.body.appendChild(fallbackFooter);
            });
    </script>
</body>
</html>