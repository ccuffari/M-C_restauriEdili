name: Firebase Hosting Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Permette di eseguire manualmente

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Firebase CLI
      run: |
        echo "Installing Firebase CLI..."
        npm install -g firebase-tools
        echo "Firebase CLI version:"
        firebase --version

    - name: Debug - Check Firebase Config
      run: |
        echo "Checking Firebase configuration..."
        ls -la | grep -E "(firebase|\.firebaserc)" || echo "No Firebase config files found"
        echo ""
        echo "Current directory structure:"
        find . -name "firebase.json" -o -name ".firebaserc" 2>/dev/null || true

    - name: Deploy to Firebase
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        echo "Starting Firebase deployment..."
        
        # Verifica che il token sia presente
        if [ -z "$FIREBASE_TOKEN" ]; then
          echo "‚ùå ERRORE: FIREBASE_TOKEN non configurato!"
          echo "Vai in Settings ‚Üí Secrets and variables ‚Üí Actions"
          echo "Aggiungi un secret chiamato FIREBASE_TOKEN con il token da: firebase login:ci"
          exit 1
        fi
        
        # Mostra info (senza esporre il token completo)
        TOKEN_PREFIX=$(echo "$FIREBASE_TOKEN" | cut -c1-10)
        echo "Token configurato: ${TOKEN_PREFIX}..."
        
        # Comando di deploy
        firebase deploy \
          --token "$FIREBASE_TOKEN" \
          --only hosting \
          --non-interactive
        
        echo "‚úÖ Deploy completato con successo!"

    - name: Success Message
      if: success()
      run: |
        echo "=========================================="
        echo "üéâ Deploy completato con successo!"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo "Data: $(date)"
        echo "=========================================="
