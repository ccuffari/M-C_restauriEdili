name: Firebase Hosting Deploy

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Tag/Version da deployare (es: v1.0.0, main, o commit SHA)'
        required: true
        default: 'main'
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.version || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && github.ref) || github.ref }}
        fetch-depth: 0
        token: ${{ secrets.GH_PAT }}  # ‚Üê Usa il PAT qui

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Firebase CLI
      run: |
        echo "Installing Firebase CLI..."
        npm install -g firebase-tools

    - name: Deploy to Firebase
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        echo "Starting Firebase deployment..."
        
        if [ -z "$FIREBASE_TOKEN" ]; then
          echo "‚ùå ERRORE: FIREBASE_TOKEN non configurato!"
          exit 1
        fi
        
        firebase deploy \
          --token "$FIREBASE_TOKEN" \
          --only hosting \
          --non-interactive
        
        echo "‚úÖ Deploy completato con successo!"

    - name: Create and Push Git Tag (solo per deploy su main)
      if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
      env:
        GH_TOKEN: ${{ secrets.GH_PAT }}  # ‚Üê Usa il PAT anche qui
      run: |
        # Genera un numero di versione basato sulla data
        VERSION="v$(date +'%Y.%m.%d.%H%M%S')"
        
        # Configura git
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        # Crea il tag
        git tag -a "$VERSION" -m "Release $VERSION - Commit: ${{ github.sha }}"
        
        # Push del tag usando il PAT
        git push origin "$VERSION"
        
        echo "‚úÖ Tag $VERSION creato e pushato"

    - name: Success Message
      if: success()
      run: |
        echo "=========================================="
        echo "üéâ Deploy completato con successo!"
        echo "Branch/Tag: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo "Data: $(date)"
        echo "=========================================="
