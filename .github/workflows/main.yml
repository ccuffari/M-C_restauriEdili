name: Deploy Pipeline

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  # PR: Preview per testing
  pr-preview:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR Branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
    
    - name: Setup Firebase CLI
      run: npm install -g firebase-tools
    
    - name: Deploy Preview
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        # Channel name basato sul PR number
        CHANNEL_NAME="pr-${{ github.event.number }}"
        
        echo "ðŸš€ Deploying PR #${{ github.event.number }} to preview..."
        firebase hosting:channel:deploy "$CHANNEL_NAME" \
          --token "$FIREBASE_TOKEN" \
          --expires 7d \
          --only hosting
        
        echo "âœ… Preview deployed to channel: $CHANNEL_NAME"
        echo "ðŸ”— Preview URL: https://$CHANNEL_NAME--work-tracker-v120400.web.app"

  # Merge su main: Deploy in produzione + Release
  production-deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GH_PAT }}
    
    - name: Setup Firebase CLI
      run: npm install -g firebase-tools
    
    - name: Setup Git Identity
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
    
    - name: Calculate Next Version
      id: version
      run: |
        # Trova l'ultimo tag
        git fetch --tags
        PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "previous_tag=$PREV_TAG" >> $GITHUB_OUTPUT
        
        # Incrementa patch version (1.2.3 -> 1.2.4)
        if [[ $PREV_TAG =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
          MAJOR=${BASH_REMATCH[1]}
          MINOR=${BASH_REMATCH[2]}
          PATCH=${BASH_REMATCH[3]}
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="v$MAJOR.$MINOR.$NEW_PATCH"
        else
          # Fallback: data-based version
          NEW_VERSION="v$(date +'%Y.%m.%d.%H%M%S')"
        fi
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ”„ Version: $PREV_TAG â†’ $NEW_VERSION"
    
    - name: Create Git Tag
      run: |
        # Crea tag usando GH_PAT
        TAG_NAME="${{ steps.version.outputs.new_version }}"
        COMMIT_MSG=$(git log -1 --pretty=%B)
        
        echo "Creating tag: $TAG_NAME"
        echo "Commit message: $COMMIT_MSG"
        
        git tag -a "$TAG_NAME" \
          -m "Release $TAG_NAME"$'\n\n'"$COMMIT_MSG"
        
        # Push del tag usando il PAT
        git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git "$TAG_NAME"
        
        echo "ðŸ·ï¸ Tag $TAG_NAME creato e pushato"
    
    - name: Deploy to Production
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        echo "ðŸš€ Deploying to production..."
        
        # Verifica che firebase CLI sia installato
        firebase --version
        
        echo "Deploying with message: Release ${{ steps.version.outputs.new_version }} - ${{ github.sha }}"
        
        firebase deploy \
          --token "$FIREBASE_TOKEN" \
          --only hosting \
          --message "Release ${{ steps.version.outputs.new_version }} - ${{ github.sha }}"
        
        echo "âœ… Deployed to production"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}
      with:
        tag_name: ${{ steps.version.outputs.new_version }}
        name: Release ${{ steps.version.outputs.new_version }}
        body: |
          **Production Deployment** âœ…
          
          **Version:** ${{ steps.version.outputs.new_version }}
          **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          **Deployed:** $(date -u)
          
          **Changes since last release:**
          $(git log --pretty=format:"- %s (%h)" ${{ steps.version.outputs.previous_tag }}..HEAD --reverse 2>/dev/null || echo "- Initial release")
          
          **Deployment Logs:** [View in Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        draft: false
        prerelease: false
    
    - name: Update Changelog
      run: |
        # Crea/aggiorna CHANGELOG.md
        if [ ! -f CHANGELOG.md ]; then
          echo "# Changelog" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "All notable changes to this project will be documented in this file." >> CHANGELOG.md
          echo "" >> CHANGELOG.md
        fi
        
        # Ottieni i commit dall'ultimo tag
        PREV_TAG="${{ steps.version.outputs.previous_tag }}"
        CHANGES=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD --reverse 2>/dev/null || echo "- Initial release")
        
        # Aggiungi nuova release in cima
        TEMP_FILE=$(mktemp)
        {
          echo "# Changelog"
          echo ""
          echo "## [${{ steps.version.outputs.new_version }}] - $(date +%Y-%m-%d)"
          echo ""
          echo "$CHANGES"
          echo ""
          echo ""
          tail -n +3 CHANGELOG.md
        } > "$TEMP_FILE"
        
        mv "$TEMP_FILE" CHANGELOG.md
        
        # Commit del changelog
        git add CHANGELOG.md
        git commit -m "docs: update changelog for ${{ steps.version.outputs.new_version }}"
        
        # Push usando GH_PAT
        git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git HEAD:main
    
    - name: Success Notification
      run: |
        echo "=========================================="
        echo "ðŸŽ‰ RELEASE COMPLETATA!"
        echo "Version: ${{ steps.version.outputs.new_version }}"
        echo "Deploy: âœ… Success"
        echo "Release: âœ… Created"
        echo "Changelog: âœ… Updated"
        echo "=========================================="
