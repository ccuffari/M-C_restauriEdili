name: Simple Deploy

on:
  push:
    branches: [main]

# âœ… Questo risolve tutto - dÃ  permessi di scrittura al token auto-generato
permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Firebase CLI
      run: npm install -g firebase-tools
    
    - name: Create Version Tag
      run: |
        VERSION="v$(date +'%Y.%m.%d.%H%M%S')"
        echo "Creating tag: $VERSION"
        
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        # Usa GITHUB_TOKEN (auto-generato, ora con permessi write)
        git tag -a "$VERSION" -m "Release $VERSION - ${{ github.sha }}"
        git push origin "$VERSION"
        
        echo "âœ… Tag $VERSION created"
    
    - name: Deploy to Firebase
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        echo "ðŸš€ Deploying..."
        firebase deploy --only hosting --token "$FIREBASE_TOKEN"
        echo "âœ… Deployed!"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: Release ${{ steps.version.outputs.version }}
        draft: false
        prerelease: false
