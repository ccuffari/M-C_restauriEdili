name: Deploy Pipeline

on:
  push:
    branches: [main]

permissions:
  contents: write  # üéØ D√Ä AL GITHUB_TOKEN PERMESSI DI SCRITTURA PER TAG E RELEASE

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Firebase CLI
      run: npm install -g firebase-tools
    
    - name: Generate Version Number
      id: version
      run: |
        # Genera versione basata sulla data (funziona sempre)
        VERSION="v$(date +'%Y.%m.%d.%H%M%S')"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "üéØ Generated version: $VERSION"
    
    - name: Create Git Tag
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        echo "üè∑Ô∏è Creating tag: $VERSION"
        
        # Configura git
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        # Crea e push tag usando GITHUB_TOKEN (ora con permessi)
        git tag -a "$VERSION" -m "Release $VERSION - ${{ github.sha }}"
        git push origin "$VERSION"
        
        echo "‚úÖ Tag $VERSION created and pushed"
    
    - name: Deploy to Firebase
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        echo "üöÄ Deploying version ${{ steps.version.outputs.version }}..."
        
        firebase deploy \
          --token "$FIREBASE_TOKEN" \
          --only hosting \
          --message "Release ${{ steps.version.outputs.version }}"
        
        echo "‚úÖ Deployed successfully to Firebase!"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: Release ${{ steps.version.outputs.version }}
        body: |
          **Production Deployment** ‚úÖ
          
          **Version:** ${{ steps.version.outputs.version }}
          **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          **Deployed:** $(date -u)
          
          **Deployment Logs:** [View in Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
        draft: false
        prerelease: false
    
    - name: Success Notification
      run: |
        echo "=========================================="
        echo "üéâ RELEASE COMPLETED SUCCESSFULLY!"
        echo "Version: ${{ steps.version.outputs.version }}"
        echo "Deploy: ‚úÖ Firebase Hosting"
        echo "Release: ‚úÖ GitHub Release Created"
        echo "=========================================="
